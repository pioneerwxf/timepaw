m.utilities={breakURLCache:function(f){return "home"},browser:{init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(f){for(var a=0;a<f.length;a++){var b=f[a].string,c=f[a].prop;this.versionSearchString=f[a].versionSearch||f[a].identity;if(b){if(b.indexOf(f[a].subString)!=
-1)return f[a].identity}else if(c)return f[a].identity}},searchVersion:function(f){var a=f.indexOf(this.versionSearchString);return a==-1?void 0:parseFloat(f.substring(a+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera"},
{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,
subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]},capitalizeString:function(f){return f.charAt(0).toUpperCase()+f.slice(1)},wait:function(f){return $.Deferred(function(a){setTimeout(a.resolve,f)})},dateFormatRelative:function(f){var f=
new Date(f*1E3),a=new Date,b="",b=(a.getTime()-f.getTime())/6E4,c=a.getHours()*60+a.getMinutes();return b=f.getYear()<a.getYear()?this.dateFormat(f,"yyyy-mm-dd",false):b-c>1440?this.dateFormat(f,"mmm d",false):b-c>0?"yesterday":b<60?Math.floor(b)+" min ago":Math.floor(b/60)+" hrs ago"},cleanMemoId:function(f){return f.replace(/[:=-_@\.\/]/g,"")},dateFormat:function(){var f=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,a=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,
b=/[^-+\dA-Z]/g,c=function(a,b){a=String(a);for(b=b||2;a.length<b;)a="0"+a;return a};return function(d,e,g){var h,o,k;k={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",shortDateWithZero:"mm/dd/yyyy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",fullDatePlusTime:"dddd, mmmm d - h:MM tt",fullDateAndTime:"m/d/yy h:MM:ss TT Z",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",
isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};h="Sun,Mon,Tue,Wed,Thu,Fri,Sat,Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday".split(",");o="Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec,January,February,March,April,May,June,July,August,September,October,November,December".split(",");arguments.length==1&&Object.prototype.toString.call(d)=="[object String]"&&!/\d/.test(d)&&(e=d,d=void 0);d=d?new Date(d):new Date;if(isNaN(d))throw SyntaxError("invalid date");e=String(k[e]||e||k["default"]);
e.slice(0,4)=="UTC:"&&(e=e.slice(4),g=true);var n=g?"getUTC":"get";k=d[n+"Date"]();var l=d[n+"Day"](),p=d[n+"Month"](),r=d[n+"FullYear"](),q=d[n+"Hours"](),s=d[n+"Minutes"](),v=d[n+"Seconds"](),n=d[n+"Milliseconds"](),t=g?0:d.getTimezoneOffset(),u={d:k,dd:c(k),ddd:h[l],dddd:h[l+7],m:p+1,mm:c(p+1),mmm:o[p],mmmm:o[p+12],yy:String(r).slice(2),yyyy:r,h:q%12||12,hh:c(q%12||12),H:q,HH:c(q),M:s,MM:c(s),s:v,ss:c(v),l:c(n,3),L:c(n>99?Math.round(n/10):n),t:q<12?"a":"p",tt:q<12?"am":"pm",T:q<12?"A":"P",TT:q<
12?"AM":"PM",Z:g?"UTC":(String(d).match(a)||[""]).pop().replace(b,""),o:(t>0?"-":"+")+c(Math.floor(Math.abs(t)/60)*100+Math.abs(t)%60,4),S:["th","st","nd","rd"][k%10>3?0:(k%100-k%10!=10)*k%10]};return e.replace(f,function(a){return a in u?u[a]:a.slice(1,a.length-1)})}}(),convertURLstringsToAnchors:function(f){return f.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&~\?\/.=]+/g,function(a){return a.link(a)})},urlHash:{set:function(f){var f=$.toQueryParams(f),a=$.toQueryParams(location.hash),
b;for(b in f)a[b]=f[b];return $.toQueryString(a)},remove:function(f){var f=$.toQueryParams(f),a=$.toQueryParams(location.hash),b={},c;for(c in a)f[c]==void 0&&(b[c]=a[c]);return $.toQueryString(b)},get:function(f){return typeof f=="undefined"?$.toQueryParams(location.hash):$.toQueryParams(location.hash)[f]},go:function(f){location.hash=f.substr(0,1)=="#"?f:"#"+f;return false}}};
m.globalTemplates={dialogs:{removeLane:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Remove Lane</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">cancel</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<p><strong>Are you sure you want to remove <strong>${title}</strong> from Memolane?</strong></p>\t\t<p>All settings will be lost, and any work you\'ve put into curating this lane will be permanently gone!</p>\t\t<p><a href="#" class="btn-red float-left removeConfirm close">Yes, REMOVE the lane!</a> <a href="#" class="secondaryAction float-left close">No, I don\'t want that</a></p>\t</div></div>',removeLaneContributor:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Stop Contributing?</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">cancel</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<p><strong>Are you sure you wish to stop contributing to this lane: ${lane_title}</strong></p>\t\t<p><a href="#" class="btn-red float-left removeConfirm close">Remove me as a contributor from this lane</a> <a href="#" class="secondaryAction float-left close">No, I don\'t want that</a></p>\t</div></div>',
addFriend:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Friend Request Sent</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">close</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<h2 class="header typeJ">Cross your fingers!</h2>\t\t<p>You just sent a friend request to <strong>${first_name} ${last_name}</strong>.</p>\t\t<p><a href="#" class="btn-green float-left close">OK</a></p>\t</div></div>',acceptFriendRequest:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Accepted Friend Request</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">close</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<h2 class="header typeJ">We\'re friends!</h2>\t\t<p>You just accepted <strong>${first_name} ${last_name}\'s</strong> friend request!</p>\t\t<p>You can now see each other\'s "Friends Only" memos.</p>\t\t<p><a href="#" class="btn-green float-left close">OK</a></p>\t</div></div>',
rejectFriendRequest:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Rejected Friend Request</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">close</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<h2 class="header typeJ">It\'s not you, it\'s me</h2>\t\t<p>You just rejected <strong>${first_name} ${last_name}\'s</strong> friend request.</p>\t\t<p>At this point, you can only see each other\'s public memos.</p>\t</div></div>',
cancelFriendRequest:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Cancelled Friend Request</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">close</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<h2 class="header typeJ">It\'s not you, it\'s me</h2>\t\t<p>You just cancelled your request for <strong>${first_name} ${last_name}\'s</strong> friendship.</p>\t\t<p>At this point, you can only see each other\'s public memos.</p>\t</div></div>',
removeFriend:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Remove Friend?</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">cancel</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<p><strong>Are you sure you want to cancel your Memolane friendship with ${first_name} ${last_name}</strong>?</p>\t\t<p>You and ${first_name} ${last_name} will lose the ability to see each other\'s "Friends Only" memos and contribute to each other\'s lanes.</p>\t\t<p><a href="#" class="btn-red float-left removeConfirm close">Yes, REMOVE the friend!</a> <a href="#" class="secondaryAction float-left close">No, I don\'t want that</a></p>\t</div></div>'}};
m.deviceIsIpad=navigator.userAgent.match(/iPad/i)!=null;m.deviceIsIphone=navigator.userAgent.match(/iPhone/i)!=null;m.deviceIsAndroid=navigator.userAgent.toLowerCase().indexOf("android")>-1;m.isIE9=$.browser.version==="9.0"?true:false;m.isIE8=$.browser.version==="8.0"?true:false;m.clickOrTouchStart=Modernizr.touch?"touchstart":"click";m.clickOrTouchEnd=Modernizr.touch?"touchend":"click";m.mouseEnterOrTouchStart=Modernizr.touch?"touchstart":"mouseenter";
m.mouseLeaveOrTouchEnd=Modernizr.touch?"touchend":"mouseleave";m.mouseDownOrTouchStart=Modernizr.touch?"touchstart":"mousedown";m.mouseMoveOrTouchMove=Modernizr.touch?"touchmove":"mousemove";m.mouseUpOrTouchEnd=Modernizr.touch?"touchend":"mouseup";m.mouseOutOrTouchEnd=Modernizr.touch?"touchend":"mouseout";m.mouseOverOrTouchStart=Modernizr.touch?"touchstart":"mouseover";
m.topBar=function(f,a){return{initialize:function(){a(f).bind("resize",function(){m.topBar.runLayout()});this.runLayout()},runLayout:function(){var b=a("body"),c=a("#header"),d=a("#tb-search input");b.width()<1E3&&(c.removeClass("more1024").addClass("less1024"),d.attr("value","Search"));b.width()>=1E3&&(c.removeClass("less1024").addClass("more1024"),m.currentLane?d.attr("value","找回过去的时光"):d.attr("value","Search lanes & users"))}}}(this,jQuery,this.undefined);m.topBar.initialize();
m.topBarDropDowns=function(f,a){return{$tbDropDowns:a(".tb-dropdown"),$dropDowns:a(".dd-container"),$dropDownsListContent:a(".dd-list-content"),jScrollGutter:5,loaderClass:"small-loader-on-grey",ddListHeight:350,ddWaitHeight:100,friendsContext:"main",friendRequests:0,hashOnPageLoad:window.location.hash.substring(1).toLowerCase(),initialize:function(){var b=this;this.$tbDropDowns.bind(m.clickOrTouchStart,a.proxy(this.initDD,this));this.$dropDownsListContent.jScrollPane({verticalGutter:b.jScrollGutter});
a(document).bind(m.clickOrTouchStart,a.proxy(this.closeAllDropdownsFromClickOff,this));this.$dropDownsListContent.delegate(".dd-friends-remove",m.clickOrTouchStart,function(){b.removeFriendDialog(a(this));return false}).delegate(".dd-friends-pending-remove",m.clickOrTouchStart,function(c){b.removeFriendPendingRequest(c,a(this));return false}).delegate(".dd-friends-friend-yes",m.clickOrTouchStart,function(c){b.acceptFriendRequest(c,a(this));return false}).delegate(".dd-friends-friend-no",m.clickOrTouchStart,
function(c){b.rejectFriendRequest(c,a(this));return false}).delegate(".dd-lanes-remove",m.clickOrTouchStart,function(){b.removeLaneDialog(a(this));return false}).delegate(".dd-lanes-fav-remove",m.clickOrTouchStart,function(){b.removeLaneFav(a(this));return false}).delegate(".dd-lanes-edit",m.clickOrTouchStart,function(){b.editLane(a(this))}).delegate(".dd-lanes-remove-contrib",m.clickOrTouchStart,function(){b.removeLaneContributorDialog(a(this));return false});a(".dd-friends-types").delegate("a",
m.clickOrTouchStart,function(a){b.toggleFriendsTypes(a);return false});this.getNewNewsNumber();this.getIncomingFriendsRequestsNumber();if(this.hashOnPageLoad){var c=m.utilities.urlHash.get("topBar");c&&setTimeout(function(){switch(c){case "getFriends":a("#dd-friends-button").trigger("click");break;case "getNews":a("#dd-news-button").trigger("click");break;case "getLanes":a("#dd-lanes-button").trigger("click")}},1500)}a("#dd-lanes .smallButtonBar li a").bind(m.clickOrTouchStart,function(){var c=a(this);
if(c.hasClass("smallButtonActive"))return false;var e=a(this).parent().attr("id");c.closest("ul").find("a").removeClass("smallButtonActive").end().end().addClass("smallButtonActive");a("#dd-fav-lanes,#dd-your-lanes").hide();a("#"+e.slice(0,e.indexOf("-btn"))).addClass("visibility-hidden").show().height(100);c=a("#"+e.slice(0,e.indexOf("-btn"))+" ul").height();c=c>400?400:c;a("#"+e.slice(0,e.indexOf("-btn"))).show().css("height",c+"px").removeClass(b.loaderClass).jScrollPane({verticalGutter:b.jScrollGutter}).removeClass("visibility-hidden").find(".jspVerticalBar").removeClass("visibility-hidden");
return false})},initDD:function(b){var b=a(b.currentTarget),c=b.attr("data-ddid"),d=a("#"+c),e=a(".dd-container");if(d.css("visibility")==="visible")return this.closeDropdown(b,d),false;else{switch(c){case "dd-friends":this.getFriends();break;case "dd-lanes":this.getLanes();break;case "dd-news":this.getNews()}e.filter(function(){return a(this).css("visibility")=="visible"}).length&&this.closeAllDropdowns();this.positionDropdown(b,d)}},getNews:function(){var b=this,c=a("#dd-news");c.find(".dd-list-content").addClass(b.loaderClass).css("height",
b.ddWaitHeight).find("ul").empty().end().find(".jspVerticalBar").addClass("visibility-hidden");b.getNewNewsNumber();a.ajax({url:"/feed",cache:false,success:function(d){for(var e=0,g=d.feed.length,h={},o=h="",f="";e<g;)h=d.feed[e],h.date_str=m.utilities.dateFormatRelative(h.created_at),f=b.templates.news[h.type],h=a("<div />").append(a.tmpl(f,h)).html(),o=h+o,e++;g===0&&(o='<li class="no-dd-list-item">No news yet</li>');c.find(".dd-list-content ul").html(o);d=c.find(".dd-list-content ul").height();
d=d>b.ddListHeight?b.ddListHeight:d;c.find(".dd-list-content").removeClass(b.loaderClass).css("height",d+"px").jScrollPane({verticalGutter:b.jScrollGutter}).find(".jspVerticalBar").removeClass("visibility-hidden")}})},getNewNewsNumber:function(){var b=4;a.ajax({url:"/feed/volume",success:function(c){b=parseInt(c.volume);b>0?a("#tb-news-count").css("display","inline").children("span").text(b):a("#tb-news-count").css("display","none")}})},hideNewNewsIndicator:function(){var b=a("#tb-news-count");b.css("display")!=
"none"&&b.fadeOut()},getFriends:function(){var b=this;a("#dd-friends");var c=a(".dd-friends-main-pane"),d=a(".dd-friends-pending-pane");a(".dd-friends-types .smallButtonBar a").removeClass("smallButtonActive");a("#dd-friends-main").addClass("smallButtonActive");d.show().find("ul").empty();c.show();c.css("height",b.ddWaitHeight).addClass(b.loaderClass).find("ul").empty().end().find(".jspVerticalBar").addClass("visibility-hidden");a.ajax({url:"/friends/all",cache:false,success:function(e){var g=0,h=
{},h="",o={},f="",n="",l="",n=e.length,l=l=0,p={pending:0,requested:0,accepted:0};for(content={pending:"",accepted:"",requested:""};g<n;)h=e[g],l=h.status,p[l]++,o=b.templates.friends[l],h=a("<div />").append(a.tmpl(o,h)).html(),content[l]+=h,g++;p.requested||p.accepted?(f+=content.requested,f+=content.accepted):f='<li class="no-dd-list-item">You got peeps, everyone does. Why not make a friend. You can use search to find memolane users to befriend. Or visit a users dashboard and request some good old fashion friendship.</li>';
n=p.pending?content.pending:'<li class="no-dd-list-item">At this time you haven\'t requested any friendships. Give it a crack. This internet thing is a whole lot funnier with friends.</li>';c.find("ul").html(f);l=c.find("ul").height();l=l>b.ddListHeight?b.ddListHeight:l;c.css("height",l+"px").removeClass(b.loaderClass).jScrollPane({verticalGutter:b.jScrollGutter}).find(".jspVerticalBar").removeClass("visibility-hidden");d.find("ul").html(n);l=d.find("ul").height();l=l>b.ddListHeight?b.ddListHeight:
l;d.hide().css("height",l+"px").removeClass(b.loaderClass).jScrollPane({verticalGutter:b.jScrollGutter}).find(".jspVerticalBar").removeClass("visibility-hidden");b.setNewFriendsIndicator(p.requested)}})},getIncomingFriendsRequestsNumber:function(){var b=this;a.ajax({url:"/friends/requested",cache:false,success:function(a){b.setNewFriendsIndicator(a.length)}})},setNewFriendsIndicator:function(b){this.friendRequests=b;b>0?a("#tb-friends-count").css("display","inline").children("span").text(b):a("#tb-friends-count").css("display",
"none")},toggleFriendsTypes:function(b){var c=a(b.target),d=c.attr("id").replace("dd-","");this.friendsContext=d;a("#dd-friends .dd-list-content").hide();a(".dd-"+d+"-pane").show();a(".dd-friends-types .smallButtonBar a").removeClass("smallButtonActive");c.addClass("smallButtonActive");b.preventDefault()},removeFriendDialog:function(b){var c=this,d={first_name:b.attr("data-first_name"),last_name:b.attr("data-last_name"),username:b.attr("data-username")},b=a.tmpl(m.globalTemplates.dialogs.removeFriend,
d);b.find(".removeConfirm").bind(m.clickOrTouchEnd,{something:"other"},function(a){m.dashboard?m.dashboard.removeFriend(d.username):c.removeFriend(d.username);a.preventDefault()});b.lightbox_me({centered:true})},removeFriend:function(b){var c=this;a.ajax({type:"delete",url:"/friends/"+b,success:function(){c.getFriends()}})},rejectFriendRequest:function(b,c){var d={first_name:c.attr("data-first_name"),last_name:c.attr("data-last_name"),username:c.attr("data-username")};$dialog=a.tmpl(m.globalTemplates.dialogs.rejectFriendRequest,
d);$dialog.lightbox_me({centered:true});m.dashboard?m.dashboard.removeFriend(d.username):this.removeFriend(d.username);this.getFriends();this.setNewFriendsIndicator(this.friendRequests-1)},acceptFriendRequest:function(b,c){var d={username:c.attr("data-username"),first_name:c.attr("data-first_name"),last_name:c.attr("data-last_name")};m.dashboard?m.dashboard.acceptFriend(d.username):a.ajax({type:"post",cache:false,url:"/friends/"+d.username+"/accept",success:function(){$dialog=a.tmpl(m.globalTemplates.dialogs.acceptFriendRequest,
d);$dialog.lightbox_me({centered:true})}});this.getFriends();this.setNewFriendsIndicator(this.friendRequests-1)},removeFriendPendingRequest:function(a,c){var d=c.data("username");m.dashboard?m.dashboard.removeFriend(d):this.removeFriend(d);this.getFriends()},getLanes:function(){var b=this,c=a("#dd-lanes"),d=a("#dd-your-lanes");a("#dd-your-lanes-btn a").addClass("smallButtonActive");a("#dd-fav-lanes-btn a").removeClass("smallButtonActive");a("#dd-fav-lanes").hide().find("ul").empty();d.show().css("height",
b.ddWaitHeight).addClass(b.loaderClass).find("ul").empty().end().find(".jspVerticalBar").addClass("visibility-hidden");a.ajax({url:"/"+m.currentUser.username+"/lanes",cache:false,success:function(e){e.length?a.tmpl(b.templates.lanes.main,e).appendTo(c.find("#dd-your-lanes ul")):a('<li class="no-dd-list-item">Start building a lane by clicking on the "New Lane" button above.</li>').appendTo(c.find("#dd-your-lanes ul"));e=d.find("ul").height();e=e>400?400:e;c.find("#dd-your-lanes").css("height",e+"px").removeClass(b.loaderClass).jScrollPane({verticalGutter:b.jScrollGutter}).find(".jspVerticalBar").removeClass("visibility-hidden")}});
a.ajax({url:"/"+m.currentUser.username+"/favorite_lanes",cache:false,data:{username:m.currentUser.username},success:function(d){d.length?a.tmpl(b.templates.lanes.fav,d).appendTo(c.find("#dd-fav-lanes ul")):a('<li class="no-dd-list-item">Quickly and easily find your way back to your favorite lanes by clicking on the heart button to add them to this list.</li>').appendTo(c.find("#dd-fav-lanes ul"))}})},removeLaneDialog:function(b){var c=this,d=b.attr("data-lane_title"),e=b.attr("data-lane_id"),d=a.tmpl(m.globalTemplates.dialogs.removeLane,
{title:d});d.find(".removeConfirm").bind(m.clickOrTouchEnd,function(d){b.closest("li").remove();var h=a("#dd-your-lanes").find("ul").height(),h=h>400?400:h;a("#dd-your-lanes").css("height",h+"px").removeClass(c.loaderClass).jScrollPane({verticalGutter:c.jScrollGutter});m.dashUser?m.dashboard.removeLane(e):c.removeLane(e);d.preventDefault()});d.lightbox_me({centered:true})},removeLaneFav:function(b){var c=b.attr("data-lane_id");b.closest("li").remove();b=a("#dd-fav-lanes").find("ul").height();b=b>
400?400:b;a("#dd-fav-lanes").css("height",b+"px").removeClass(this.loaderClass).jScrollPane({verticalGutter:this.jScrollGutter});m.dashUser?a(".dashFaves #"+c).find(".remove-fav").trigger(m.clickOrTouchEnd):m.currentLane&&m.currentLane.id===c?a("#favorite-un-fav").trigger(m.clickOrTouchEnd):a.ajax({url:"/lanes/favorite",type:"DELETE",data:{lane_id:c}})},removeLaneContributorDialog:function(b){var c=this,d=b.attr("data-lane_title"),e=b.attr("data-lane_id"),g=b.attr("data-owner"),b="",d={lane_title:d},
b=m.globalTemplates.dialogs.removeLaneContributor,d=a.tmpl(b,d);d.find(".removeConfirm").bind(m.clickOrTouchEnd,function(a){m.dashboard?m.dashboard.removeLaneContributor(e):c.removeLaneContributor(e,g);a.preventDefault()});d.lightbox_me({centered:true})},editLane:function(a){a=a.data("id");if(m.currentLane&&m.currentLane.id==a)return window.location="/"+m.currentUser.username+"/"+m.currentLane.title+"?e=1#drawer=edit",false},removeLane:function(b){var c=this;a.ajax({type:"delete",url:"/lanes/"+b,
success:function(){if(m.currentLane&&m.currentLane.id==b)return window.location="/"+m.currentUser.username,false;else c.getLanes()}})},removeLaneContributor:function(b,c){var d=this;a.ajax({type:"delete",url:"/lanes/contributor",data:{lane_id:b,username:m.currentUser.username},success:function(){if(m.currentLane&&m.currentLane.id==b)return window.location="/"+c+"/"+m.currentLane.title,false;else d.getLanes()}})},openDropdown:function(a,c){a.addClass("tb-dropdown-open");m.search&&m.search.closeSearchDD();
c.css("visibility","visible")},closeDropdown:function(a,c){a.data("ddid")=="dd-news"&&this.hideNewNewsIndicator();a.removeClass("tb-dropdown-open");c.css("visibility","hidden")},closeAllDropdownsFromClickOff:function(b){a(b.target).closest(".dd-container,.tb-dropdown, .memolaneDialog").length||this.closeAllDropdowns()},closeAllDropdowns:function(){a(".dd-container").css("visibility","hidden");this.$tbDropDowns.removeClass("tb-dropdown-open")},positionDropdown:function(b,c){var b=b||a(".tb-dropdown-open"),
c=c||a(".dd-container").filter(function(){return a(this).css("visibility")=="visible"}),d=b.offset().left,e=b.offset().top+45,g=a(window).width();d+c.width()>g&&(d-=d+c.width()-g);c.css({top:e+"px",left:d+"px"});c.css("visibility")==="hidden"&&this.openDropdown(b,c);return false},templates:{news:{friendship_request:"",welcome_shout:'<li class="clearfix {{if is_new==true}}new-news{{/if}}"><div class="dd-news-item"><img src="/img/dropdowns/news-welcome.png">Welcome to Memolane! Let your <a class="shareURL" href="#" data-share-link="/'+
(m.currentUser?m.currentUser.username:"")+'" data-share-text="Check out my new Memolane profile" data-share-dialog-text="Share profile on"><span class="icon"></span>Twitter and Facebook</a> friends know so you can share your memories.</div><div class="dd-news-item-date">${date_str}</div></li>',welcome_invite:'<li class="clearfix {{if is_new==true}}new-news{{/if}}"><div class="dd-news-item"><img src="/img/dropdowns/news-tell-friends.png">Tell a friend about Memolane!</div><div class="dd-news-item-date">${date_str}</div></li>',
new_user_invited_by:'<li class="clearfix {{if is_new==true}}new-news{{/if}}"><div class="dd-news-item"><a href="/${content.other.username}">\t<img src="/${content.other.username}/image"></a><a href="**SEND_INVITOR_FRIEND_REQUEST**">Click here</a> to send them a friend request</div><div class="dd-news-item-date">${date_str}</div></li>',friendship:'<li class="clearfix {{if is_new==true}}new-news{{/if}}"><div class="dd-news-item"><a href="/${content.friend.username}">\t${content.friend.first_name} ${content.friend.last_name}</a> and <a href="/${content.other.username}">\t${content.other.first_name} ${content.other.last_name}</a> are now friends</div><div class="dd-news-item-date">${date_str}</div></li>',
friendship_request_accepted:'<li class="clearfix {{if is_new==true}}new-news{{/if}}"><div class="dd-news-item"><a href="/${content.friend.username}">\t<img src="/${content.friend.username}/image"></a><a href="/${content.friend.username}">\t${content.friend.first_name} ${content.friend.last_name}</a> is now your friend</div><div class="dd-news-item-date">${date_str}</div></li>',lane_new_contributor:'<li class="clearfix {{if is_new==true}}new-news{{/if}}"><div class="dd-news-item"><a href="/lanes/${content.lane.id}" title="view lane"><img src="/lanes/${content.lane.id}/avatar.small" alt="topBarAvatar"/></a><a href="/${content.new_contributor.username}">${content.new_contributor.first_name} ${content.new_contributor.last_name}</a> has been added to the lane <span class="lane-name-DD"><a href="/lanes/${content.lane.id}" title="view lane">${content.lane.title}</a></span></div><div class="dd-news-item-date">${date_str}</div></li>',
added_to_lane:'<li class="clearfix {{if is_new==true}}new-news{{/if}}"><div class="dd-news-item"><a href="/${content.added_by.username}">\t<img src="/${content.added_by.username}/image"></a><a href="/${content.added_by.username}">\t${content.added_by.first_name} ${content.added_by.last_name}</a> has added you as a contributor to the lane <a href="/lanes/${content.lane.id}">${content.lane.title}</a></div><div class="dd-news-item-date">${date_str}</div></li>'},lanes:{main:'<li class="clearfix">\t<a href="/${owner.username}/${title}" title="view lane">\t\t<div class="dd-list-item">\t\t\t<img src="/lanes/${id}/avatar.small" alt="topBarAvatar"/>\t\t\t<span class="lane-name-DD">${title}</span>\t\t\t{{if role=="contributor"}}\t\t\t<span class="lane-type-DD">(contributor)</span></div>\t<a href="#" class="dd-lanes-remove-contrib" data-lane_id="${id}" data-owner="${owner.username}" data-lane_title="${title}" title="remove my content from this lane">X</a>\t{{else}}\t</div>\t<a href="#" class="dd-lanes-remove" data-lane_id="${id}" data-lane_title="${title}"  title="delete lane" >X</a>\t<a href="/${owner.username}/${title}#drawer=edit" class="dd-lanes-edit" title="edit lane" data-id="${id}">X</a>\t{{/if}}\t</a></li>',
fav:'<li class="clearfix"><a href="/${owner.username}/${title}" title="view lane"><div class="dd-list-item"><img src="/lanes/${id}/avatar.small" alt="topBarAvatar"/><span class="lane-name-DD">${title}</span><span class="lane-type-DD">by ${owner.first_name} ${owner.last_name} (${owner.username})</span></div>{{if true}}<a href="#" class="dd-lanes-fav-remove" data-lane_id="${id}" data-lane_title="${title}"  title="Remove from favorites" >X</a>{{/if}}</a></li>'},friends:{accepted:'<li class="clearfix"><a href="/${other_username}" title="view dashboard"><div class="dd-list-item"><img src="/${other_username}/image" alt="topBarAvatar"/><span class="name-friends-DD">${other_first_name} ${other_last_name}</span> <span class="user-name-friends-DD">(${other_username})</span></div><a href="#" class="dd-friends-remove" title="remove friend" data-username="${other_username}" data-first_name="${other_first_name}"  data-last_name="${other_last_name}">X</a></div></a></li>',
requested:'<li class="clearfix friend-request-list">\t<a href="/${other_username}" title="view dashboard">\t\t<div class="dd-list-item">\t\t\t<img src="/${other_username}/image" alt="topBarAvatar"/>\t\t\t<span class="name-friends-DD">${other_first_name} ${other_last_name}</span> \t\t\t<span class="user-name-friends-DD">(${other_username})</span>\t\t</div>\t\t<a href="#" data-username="${other_username}" data-first_name="${other_first_name}" \t\t\tdata-last_name="${other_last_name}" class="dd-friends-friend-no" \t\t\ttitle="Deny Friendship Request">Deny</a> \t<a href="#" data-username="${other_username}" data-first_name="${other_first_name}" data-last_name="${other_last_name}" class="dd-friends-friend-yes" title="Confirm Friendship Request">Confirm</a></div></a></li>',
pending:'<li class="clearfix"><a href="/${other_username}" title="view dashboard"><div class="dd-list-item"><img src="/${other_username}/image" alt="topBarAvatar"/><span class="name-friends-DD">${other_first_name} ${other_last_name}</span> <span class="user-name-friends-DD">(${other_username})</span></div><a href="#" data-username="${other_username}" class="dd-friends-pending-remove" title="remove friend request" data-username="${other_username}" data-first_name="${other_first_name}"  data-last_name="${other_last_name}">X</a></div></a></li>'}}}}(this,
jQuery,this.undefined);m.currentUser!=null&&m.topBarDropDowns.initialize();
m.search=function(f,a,b){return{$searchInput:a("#search-input"),$closeSearchBtn:a("#close-search-btn"),$searchDD:a("#dd-search"),$tbSearch:a("#tb-search"),$searchTypesA:a("#search-types a"),$searchResults:a(".search-results"),searchDDOpen:false,searchContext:m.currentLane?"search-memos":"search-lanes",loaderClass:"small-loader-on-grey",jScrollGutter:5,maxDDContentHeight:320,searchLaneScope:"world",searchTimeout:b,initialize:function(){m.currentLane||(a("#search-memos").hide(),a("#search-lanes").show(),
a("#search-lanes-filter-friends").show());var b=this;this.$searchInput.focus(a.proxy(this.searchInputFocus,this)).blur(a.proxy(this.searchInputBlur,this)).keyup(a.proxy(this.searchInputkeyup,this));this.$closeSearchBtn.bind(m.clickOrTouchStart,a.proxy(function(){this.closeSearchDD()},this));a(document).bind(m.clickOrTouchStart,a.proxy(this.closeSearchDDFromClickOff,this));this.$searchTypesA.bind(m.clickOrTouchStart,a.proxy(function(a){this.toggleSearchContext(a)},this));this.$searchResults.delegate(".request-friendship",
m.clickOrTouchStart,function(){b.addFriendDialog(a(this));return false});a("#search-lanes-filter-friends input").bind(m.clickOrTouchStart,function(){b.setLaneSearchFilter(a(this))})},searchInputFocus:function(b){var d=a(b.target),e=d.val();d.val(e===b.target.defaultValue?"":e).addClass("search-focused").data("hasFocus",true);this.$closeSearchBtn.show()},searchInputBlur:function(b){var d=a(b.target);this.$searchDD.css("visibility")!=="visible"&&(d.val(b.target.defaultValue).removeClass("search-focused").data("hasFocus",
false),this.$closeSearchBtn.hide(),this.$tbSearch.css("background-color","transparent"))},closeSearchDD:function(){this.$searchDD.css("visibility","hidden");this.$searchInput.trigger("blur");this.searchDDOpen=false},closeSearchDDFromClickOff:function(b){a(b.target).closest("#dd-search,#tb-search,.memolaneDialog").length||this.closeSearchDD()},searchInputkeyup:function(b){a(b.target);b=this.$searchInput.val();if(b.length!=0&&b.length>=3||this.searchDDOpen)this.searchDDOpen===false&&(this.$tbSearch.css("background-color",
"#f1f1f1"),this.openSearchDD()),this.doSearchDebounce(this.searchContext),foo=false},openSearchDD:function(){this.searchDDOpen=true;m.topBarDropDowns.closeAllDropdowns();this.$searchDD.css("visibility","visible")},toggleSearchContext:function(b){var d=a(b.target),e=d.attr("id").replace("dd-","");e==="search-lanes"?a("#search-lanes-filter-friends").show():a("#search-lanes-filter-friends").hide();this.searchContext=e;this.$searchResults.hide();this.$searchTypesA.removeClass("smallButtonActive");d.addClass("smallButtonActive");
this.doSearchDebounce(e);b.preventDefault()},setLaneSearchFilter:function(a){a.attr("id");this.searchLaneScope=a.is(":checked")===true?"friends":"world";this.doContextSearch(0,"search-lanes")},doSearchDebounce:_.debounce(function(a){this.doContextSearch(0,a)},200),doContextSearch:function(b,d,e){var g=this,h=a("#"+d).show(),f=h.find("ul"),k=this.$searchInput.val(),n="",l="",p="",e=e||10,r=a("#"+d+"-hits");g.searchContext=d;switch(d){case "search-memos":n="/search/memos";p="memos";l="";lane=m.currentLane.id;
break;case "search-lanes":n="/search/lanes";p="lanes";l=g.searchLaneScope;lane="";break;case "search-users":n="/search/users",p="users",l="world",lane=""}b==0&&(f.html(""),h.find(".search-results-scrollable").data("jsp")&&h.find(".search-results-scrollable").data("jsp").destroy(),h.show());a("#"+d+"-loader").show();e>b?a.ajax({type:"get",url:n,data:{q:k,start:b,limit:10,scope:l,lane:lane},success:function(e,n,k){a("#"+d+"-loader").hide();b==0&&h.removeClass(g.loaderClass);parseInt(e.hits)==0||k.status==
204?f.find(".search-no-results").length===0&&(a.tmpl(g.templates[d].empty,{}).appendTo(f),r.html(""),h.find(".search-results-scrollable").height(40)):(a.tmpl(g.templates[d].results,e[p]).appendTo(f),f.height()>=g.maxDDContentHeight?h.find(".search-results-scrollable").height(g.maxDDContentHeight).jScrollPane({verticalGutter:g.jScrollGutter}):h.find(".search-results-scrollable").height(f.height()),h.find(".jspScrollable").bind("jsp-scroll-y",function(h,f,o,n){n===true&&(h=b+10,e.hits>h&&g.doContextSearch(h,
d,e.hits),a(this).unbind("jsp-scroll-y"))}),b==0?r.html(e.hits+" total results"):h.find(".search-results-scrollable").data("jsp").reinitialise())}}):a("#"+d+"-loader").hide()},linkToMemo:function(a,b){return m.utilities.breakURLCache(window.location.pathname)+"#time="+b+"&memo="+m.utilities.cleanMemoId(a)},addFriendDialog:function(b){b={username:b.data("username"),first_name:b.data("first_name"),last_name:b.data("last_name")};a.tmpl(m.globalTemplates.dialogs.addFriend,b).lightbox_me({centered:true});
m.dashboard?m.dashboard.addFriend(b.username):a.ajax({type:"post",url:"/friends/"+b.username,success:function(){}})},templates:{"search-memos":{results:'<li class="clearfix"><a href="${m.search.linkToMemo(id, created_at)}" title="view memo"><div class="search-service-icon ${service}-icon"></div><img src="/${user.username}/images" alt="lane" class="search-user-avatar" title="${title}" height="20" width="20" /><div class="search-memos-txt">${title.substring(0, 75) + ( title.length > 75 ? "..." : "") }<span class="search-memos-date">${m.utilities.dateFormat((created_at*1000), "UTC:ddd mmm dd yyyy HH:MM:ss")}</span></div></a></li>',
empty:'<li class="clearfix search-no-results">No memos match that search term!</li>'},"search-lanes":{results:'{{if user}}<li class="clearfix"><a href="/${user.username}/${title}" title="view lane"><img src="/lanes/${id}/avatar.small" class="search-result-icon search-lane-image" alt="topBarAvatar" title="${title}" height="20" width="20" /><span class="search-results-txt">${title}{{if m.currentUser.userID != user_id}}<span class="search-lanes-rel">(${user.first_name} ${user.last_name})</span>{{/if}}</span></a></li>{{/if}}',
empty:'<li class="clearfix search-no-results">No lanes match that search term!</li>'},"search-users":{results:'<li class="clearfix"><a href="/${username}" title="view user profile"><img src="/${username}/images" height="20" width="20" class="search-result-icon search-user-avatar" alt="topBarAvatar"/><span class="search-results-txt">${first_name} ${last_name}<span class="search-users-username">(${username})</span></span> {{if friend=="pending"}}{{else friend=="self"}}{{else friend=="accepted"}}{{else}}<a href="#" data-first_name="${first_name}" data-last_name="${last_name}" data-username="${username}" class="request-friendship" title="request friendship">Request Friendship</a></a>{{/if}}</a></li>',
empty:'<li class="clearfix search-no-results">No users match that search term!</li>'}}}}(this,jQuery,this.undefined);m.search.initialize();
m.timeline=function(f,a,b){return{$timeline:a("#timeline"),$fixedIndicator:a("#timelineCurrent"),$hoverIndicator:a("#timelineHover"),$hoverIndicatorTooltip:a("#timeline-tooltip"),timelineWidth:null,timelineInnerWidth:0,beginDateWidth:0,endDateWidth:0,fixedIndicatorWidth:0,fixedIndicatorXRatio:0,initialize:
function(){
this.$timeline.bind(m.clickOrTouchEnd,a.proxy(this.handleClick,this));Modernizr.touch||this.$timeline.bind("mousemove",a.proxy(this.showHoverIndicator,this)).bind("mouseleave",a.proxy(this.hideHoverIndicator,this));this.resetSizeValues()
},
resetSizeValues:function(){this.timelineWidth=this.$timeline.width();this.beginDateWidth=a("#timelineBeginDate").outerWidth();this.endDateWidth=a("#timelineEndDate").outerWidth();this.timelineInnerWidth=this.timelineWidth-this.beginDateWidth-this.endDateWidth;this.fixedIndicatorWidth=
this.$fixedIndicator.outerWidth()},showFixedIndicator:function(c,d){var e=true;c==b&&this.fixedIndicatorXRatio!=b?c=this.fixedIndicatorXRatio:c==b&&(c=1,e=false);c<=0?c=0:c>=1&&(c=1);if(e)this.fixedIndicatorXRatio=c;d||(d=Math.round(m.currentLane.first_memo+(m.currentLane.last_memo-m.currentLane.first_memo)*c));a("#timelineDate").text(m.utilities.dateFormat(d*1E3,"mediumDate"));this.fixedIndicatorWidth=this.$fixedIndicator.outerWidth();e=c*this.timelineInnerWidth+this.beginDateWidth;e>this.timelineWidth-
this.endDateWidth&&(e=this.timelineWidth-this.endDateWidth);e+this.fixedIndicatorWidth>=this.timelineWidth-this.endDateWidth?(e-=this.fixedIndicatorWidth,this.$fixedIndicator.css("left",Math.round(e)+"px").addClass("indicatorRight")):this.$fixedIndicator.css("left",Math.round(e)+"px").removeClass("indicatorRight");this.$fixedIndicator.is(":hidden")&&this.$fixedIndicator.show()},onResize:function(a){this.resetSizeValues();this.showFixedIndicator(a)},showFixedIndicatorByTimestamp:function(a){if(!a)a=
m.lane.currentlyCenteredLaneMemoTime;xRatio=(a-m.currentLane.first_memo)/(m.currentLane.last_memo-m.currentLane.first_memo);this.showFixedIndicator(xRatio,a)},showHoverIndicator:function(a){var b=null,b=null,b=(a.pageX-this.beginDateWidth)/this.timelineInnerWidth,b=Math.round(m.currentLane.first_memo+(m.currentLane.last_memo-m.currentLane.first_memo)*b),a=a.pageX-3;this.$hoverIndicator.css("left",a+"px");this.$hoverIndicatorTooltip.css("left",a-47+"px");a>this.timelineWidth-this.endDateWidth||a<=
this.beginDateWidth?(this.$hoverIndicator.hide(),this.$hoverIndicatorTooltip.hide()):(this.$hoverIndicator.show(),this.$hoverIndicatorTooltip.text(m.utilities.dateFormat(b*1E3,"UTC:yyyy-mm-dd")).show())},hideHoverIndicator:function(){this.$hoverIndicator.hide();this.$hoverIndicatorTooltip.hide()},handleClick:function(a){var b=null,e=null;if(a.originalEvent.touches||a.originalEvent.changedTouches)var g=a.originalEvent.touches[0]||a.originalEvent.changedTouches[0];a.target.id=="timelineBeginDate"?
(b=0,e=m.currentLane.first_memo):a.target.id=="timelineEndDate"?(b=1,e=m.currentLane.last_memo):(b=((a.pageX||g.pageX)-this.beginDateWidth)/this.timelineInnerWidth,e=Math.round(m.currentLane.first_memo+(m.currentLane.last_memo-m.currentLane.first_memo)*b));this.showFixedIndicator(b);a="";m.isEmbedded&&(a+="&embedded=true");m.embeddedParams.background!=""&&(a+="&embedded_background="+m.embeddedParams.background);m.embeddedParams.border!=""&&(a+="&embedded_border="+m.embeddedParams.border); var selectedTmp = new Date(e*1000); var selectedMonth = selectedTmp.getMonth()+1; var selectedDay = selectedTmp.getDate();
if (selectedMonth<10) {selectedMonth = "0"+selectedMonth;}
if (selectedDay<10) {selectedDay = "0"+selectedDay;}
var selectedDate = selectedTmp.getFullYear()+""+selectedMonth+""+selectedDay;
f.location.href=
m.utilities.breakURLCache("/"+m.currentLane.owner.username+"/"+m.currentLane.title)+a+"#"+selectedDate}}}(this,jQuery,this.undefined);m.timeline.initialize();
m.laneLayout=function(f,a){return{timelineHeight:42,heightOfHeader:m.isEmbedded?0:120,heightOfDateBar:25,heightOfBranding:m.isEmbedded?38:0,initialize:function(){a(f).bind("resize",function(a){m.laneLayout.runLayout(a)});this.runLayout(false)},runLayout:function(b){var c=a("#lane-viewport"),d=a("#lane");a(".lane-slot");var e=a(".lane-slot-memos"),g=a("#content"),h=a("body"),f=a("#lane-drawer-content"),k=a("#lane-drawer"),n=a("#lane-drawer-tab"),l=a("#header"),p=a(".screenBtn"),r=a(".slot-loader"),
q=a("#drawer-actions"),s=a("#embedded-branding"),v=a("#shadow"),t=a("#screenLeftBtn"),q=q.length?43:0;if(m.isEmbedded){l.hide();n.hide();k.hide();p.css("top",28);r.css("top",28);if(!m.embeddedParams.background||m.embeddedParams.background==""||m.embeddedParams.background=="default")m.embeddedParams.background="black";m.embeddedParams.background!="memolane"&&h.css("background",m.embeddedParams.background);if(!m.embeddedParams.border||m.embeddedParams.border==""||m.embeddedParams.border=="default")m.embeddedParams.border=
"1px solid #FFF";g.css("border",m.embeddedParams.border);v.css("bottom",41+this.heightOfBranding);s.show();t.css("left",0)}g.css("visibility","hidden");f.height(h.height()-this.timelineHeight-k.position().top-22-q+"px");c.height(h.height()-this.heightOfHeader-this.timelineHeight-this.heightOfBranding+"px");d.height(c.height()+"px");p.add(".slot-loader").height(c.height()-this.heightOfDateBar-20+"px");e.height(c.height()-(this.heightOfDateBar+20)+"px");a("#content .lane-slot-memos").isotope({layoutMode:"fitColumns",
animationEngine:"jquery",animationOptions:{duration:0,queue:false}});var u=0;a("#content .lane-slot").each(function(){u+=a(this).outerWidth()});d.width(u+"px");g.css("visibility")==="hidden"&&g.css("visibility","visible");f.data("jsp")&&f.data("jsp").reinitialise();a(".openMemo").length&&m.memos.closeMemo();a(".dd-container").filter(function(){return a(this).css("visibility")=="visible"}).length&&m.topBarDropDowns.positionDropdown();if(b!=false)m.timeline.onResize(),m.laneLoadMemos.numberOfMemosToLoad=
Math.round(a("body").width()/250*(a("#lane-viewport").height()/250))*4}}}(this,jQuery,this.undefined);m.laneLayout.initialize();
m.drawer=function(f,a){return{$drawer:a("#lane-drawer"),$drawerContent:a("#lane-drawer-content"),$drawerActions:a("#drawer-actions"),$laneDrawerEdit:a("#lane-drawer-edit"),$laneDrawerView:a("#lane-drawer-view"),$content:a("#content"),$slotLoaderLeft:a("#slot-loader-left"),$headerLaneTitle:a("h2.lane-title"),$drawerHandler:a("#lane-drawer-tab"),$screenLeftBtn:a("#screenLeftBtn"),$drawerHandlerIcon:a("#lane-drawer-tab").find("span"),drawerIsOpen:true,currentUserIsOwner:m.currentLane.user_is_owner,currentUserIsContributor:m.currentLane.user_is_contributor,
urlHashObject:m.utilities.urlHash.get(),initialize:function(){var b=this,c=m.currentLane.mode;this.$drawerHandler.bind(m.clickOrTouchStart,a.proxy(this.onClickOrTouchStart,this));Modernizr.sessionstorage&&!sessionStorage.getItem("drawerAware")&&c!=="new"&&this.urlHashObject.drawer!=="open"&&this.urlHashObject.drawer!=="edit"?(sessionStorage.setItem("drawerAware",true),this.$screenLeftBtn.stop().animate({left:this.$drawer.outerWidth()},400,"easeOutCubic"),this.$drawer.css("visibility","visible"),setTimeout(function(){b.closeDrawer(1E3)},
9E3)):c==="new"||this.urlHashObject.drawer==="open"||this.urlHashObject.drawer==="edit"||m.currentLane.total_memos===0||m.currentLane.visible_memos===0?(this.$screenLeftBtn.stop().animate({left:this.$drawer.outerWidth()},400,"easeOutCubic"),this.$drawer.css("visibility","visible")):this.closeDrawer(0,function(){b.$drawer.css("visibility","visible")});a("#lane-drawer-content").jScrollPane({verticalGutter:10});a(document).keyup(function(b){if(a("input:focus,textarea:focus,select:focus").length)return false;
switch(b.which){case 68:m.drawer.drawerIsOpen?m.drawer.closeDrawer():m.drawer.openDrawer()}});c==="new"?(this.addNewView(),a('<div class="notifications warningnews-notice"><div class="notice-text"><p class="zeroMarginBottom">Don\'t forget to to turn on the services you want to stream to this lane.</p><a href="#" class="close-notice">X</a></div></div>').notify({expires:7500})):this.urlHashObject.drawer==="edit"?this.addEditView():this.addLaneView();this.urlHashObject.firstLane==="yes"&&(sessionStorage.getItem("drawerAware")&&
setTimeout(function(){b.closeDrawer(1E3)},9E3),a('<div class="notifications warningnews-notice"><div class="notice-text"><p>Welcome to memolane!</p><p class="zeroMarginBottom">By default your first lane streams all the services you just added. When creating new lanes you\'ll have to turn on streaming manually or add memos manually to populate the lane with memos. </p><a href="#" class="close-notice">X</a></div></div>').notify({expires:false}));a(".openDrawerOnClick").live("click",function(){m.drawer.openDrawer();
return false});a(".openDrawerEditViewOnClick").live("click",function(){a("#drawer-edit-lane-link").trigger("click");m.drawer.openDrawer();return false})},addNewView:function(){var b=this;this.showDrawerLoader();_.delay(a.proxy(this.openDrawer,this),1E3);a.when(a.ajax({url:"/lanes/"+m.currentLane.id+"/available_services"}),a.ajax({url:"/lanes/"+m.currentLane.id+"/available_contributors"})).done(function(c,d){var e=a.tmpl(b.templates.drawerNew,{ser:c[0],contr:d[0],currentUser:m.currentUser,avatar:m.currentLane.avatar}).html();
b.hideDrawerLoader();b.$drawerContent.after(b.templates.createLaneAction).find(".jspPane").append(e).end().height(b.$drawerContent.height()-43).data("jsp").reinitialise();b.setupEditViewAndNewViewEvents();b.$drawer.delegate("#streaming-services input","click",function(a,c){b.serviceCheckboxToggle(this);if(c)return false});a("#lane-contrib-list li").bind("click",function(c){a(c.target).is("input")?b.contributorToggle(c.target):($checkbox=a(this).find("input"),$checkbox.prop("checked")?$checkbox.prop("checked",
false):$checkbox.prop("checked",true),b.contributorToggle($checkbox))});a("#cancel-lane-creation a").bind(m.clickOrTouchStart,function(){b.hideDrawerContent();b.showDrawerLoader();a.ajax({type:"delete",url:"/lanes/"+m.currentLane.id,success:function(){f.history.back()}});return false});a("#create-new-lane-btn").bind(m.clickOrTouchStart,function(){b.saveLane()})})},contributorToggle:function(b){var c=this,b=a(b);b.prop("checked")?a.ajax({url:"/lanes/contributor",type:"POST",data:{lane_id:m.currentLane.id,
username:b.data("username")}}).success(function(){a.ajax({url:"/lanes/"+m.currentLane.id+"/available_services",cache:false}).success(function(b){b=a.tmpl(c.templates.drawerNewServList,{ser:b}).html();a("#streaming-services").html(b);c.$drawerContent.data("jsp").reinitialise()})}):a.ajax({url:"/lanes/contributor",type:"DELETE",data:{lane_id:m.currentLane.id,username:b.data("username")}}).success(function(){a.ajax({url:"/lanes/"+m.currentLane.id+"/available_services",cache:false}).success(function(b){b=
a.tmpl(c.templates.drawerNewServList,{ser:b}).html();a("#streaming-services").html(b);c.$drawerContent.data("jsp").reinitialise()})})},serviceCheckboxToggle:function(b){a(b).is(":checked")?a.ajax({url:"/lanes/service",type:"POST",data:{lane_id:m.currentLane.id,service:a(b).data("service-name")}}):a.ajax({url:"/lanes/service",type:"DELETE",data:{lane_id:m.currentLane.id,service:a(b).data("service-name")}})},saveLane:function(){var b=this;this.hideDrawerContent();this.showDrawerLoader();a("#drawer-actions").addClass("visibility-hidden");
var c=a("#lane-title-input"),d=c.attr("placeholder"),e=c.val(),g=a("#lane-descrip-input"),c=g.attr("placeholder"),g=g.val(),h=a("#lane-input-start-date");h.val();var o=h.data("date")||"",h=a("#lane-input-end-date");h.val();var k=h.data("date")||"";a.when(e!==""&&e!==d&&m.currentLane.title!==e?a.ajax({url:"/lanes/title",type:"POST",data:{lane_id:m.currentLane.id,title:e}}):false,g!==c?a.ajax({url:"/lanes/description",type:"POST",data:{lane_id:m.currentLane.id,description:g}}):false,function(){if(a("#lane-input-end-date").val()===
k)return false;var b=a("#lane-input-end-date").val()===""?-1:Math.round((new Date(a("#lane-input-end-date").val())).getTime()/1E3);return a.ajax({url:"/lanes/bounds",type:"POST",data:{lane_id:m.currentLane.id,to:b}})}(),function(){if(a("#lane-input-start-date").val()===o)return false;var b=a("#lane-input-start-date").val()===""?-1:Math.round((new Date(a("#lane-input-start-date").val())).getTime()/1E3);return a.ajax({url:"/lanes/bounds",type:"POST",data:{lane_id:m.currentLane.id,from:b}})}()).done(function(a){a?
f.location.href="/"+m.currentUser.username+"/"+e+"#drawer=open":(f.location.href="/"+m.currentUser.username+"/"+m.currentLane.title+"#drawer=open",m.currentLane.mode!=="new"&&f.location.reload())}).fail(function(){b.showDrawerContent();b.hideDrawerLoader();a("#drawer-actions").removeClass("visibility-hidden");a("#lane-title-input").focus().tipsy({trigger:"manual",gravity:"w",fallback:"You already have a lane with this name. We can't create another lane with the same exact name."}).tipsy("show").blur(function(){a("#lane-title-input").tipsy("hide")})})},
setupEditViewAndNewViewEvents:function(){a(".lane-input-date").datepicker({dateFormat:"mm/dd/yy",constrainInput:true,changeYear:true,prevText:"<",nextText:">",closeText:"Close",onClose:function(b,c){a(c.input).val()==="mm/dd/yyyy"&&a(c.input).val("")},beforeShow:function(b){a(b).val()===""&&a(b).val("mm/dd/yyyy")}});a(".calendar-icon").click(function(){a(this).next("input").focus()});a(".uncheck-all-checkbox").bind("click",function(b){var c=a("#streaming-services input:checked");a("#streaming-services input").prop("checked",
false);c.trigger("click",[b.target]);return false});a(".check-all-checkbox").bind("click",function(b){var c=a("#streaming-services input:not(:checked)");a("#streaming-services input").prop("checked",true);c.trigger("click",[b.target]);return false});a(".lane-upload-input-file").ajaxfileupload({action:"/lanes/"+m.currentLane.id+"/avatar.upload",params:{_csrf:m.csrf},onComplete:function(){a(".lane-drawer-avatar").load(function(){a("#avatar-loader").removeClass("avatar-loader")}).attr("src",a(".lane-drawer-avatar").attr("src")+
"?time="+new Date)},onStart:function(){a("#avatar-loader").addClass("avatar-loader")}});a("#lane-title-input").alphanumeric({ichars:"#/?%:"}).keypress(function(b){a(this);(b.which==35||b.which==63||b.which==47||b.which==37||b.which==92)&&a("#lane-title-input").tipsy({trigger:"manual",gravity:"w",fallback:"Lane titles can not contain the following characters # % ? /  :"}).tipsy("show")}).blur(function(){a("#lane-title-input").tipsy("hide")});a("#cherryPickingCopy").tipsy({trigger:"hover",offset:5,
html:true,gravity:"w",fallback:'<p>Contributors of this lane can also manually add or remove their own memos to this lane by clicking on the [+] or [-] buttons on an open memo they own.</p><p class="zeroMarginBottom">Additionally the owner of the lane can manually add and remove memos from not only his memos but also any of the contributors memos.</p>'});a("#streamingCopy").tipsy({trigger:"hover",offset:5,html:true,gravity:"w",fallback:'<p class="zeroMarginBottom">Streaming a service means that you are adding all the memos that this person shares with you on this service to your lane.</p>'})},
addEditView:function(){var b=this;this.showDrawerLoader();_.delay(a.proxy(this.openDrawer,this),1E3);a.when(a.ajax({url:"/friends/all"})).done(function(){var c=a.tmpl(b.templates.drawerEdit,{laneInfo:m.currentLane,ser:m.currentLane.available_services}).html();b.hideDrawerLoader();b.showDrawerContent();b.$drawerContent.after(b.templates.saveLaneAction).find(".jspPane").append(c).end().height(b.$drawerContent.height()-43).data("jsp").reinitialise();a("#cancel-lane-edit").bind(m.clickOrTouchStart,function(){b.saveLane();
return false});a("#lane-edit-delete").bind(m.clickOrTouchStart,function(){b.removeLaneDialog();return false});b.setupEditViewAndNewViewEvents();a("#lane-contrib-list li").bind("click",function(c){a(c.target).is("input")?b.contributorToggle(c.target):($checkbox=a(this).find("input"),$checkbox.prop("checked")?$checkbox.prop("checked",false):$checkbox.prop("checked",true),b.contributorToggle($checkbox))});b.$drawer.delegate("#streaming-services input","click",function(a,c){b.serviceCheckboxToggle(this);
if(c)return false})})},removeLaneDialog:function(){var b=a.tmpl(this.templates.removeLaneDialog,{title:m.currentLane.title});b.find(".removeConfirm").bind(m.clickOrTouchEnd,function(){a.ajax({type:"delete",url:"/lanes/"+m.currentLane.id,success:function(){f.location.href="/"+m.currentUser.username}});return false});b.lightbox_me({centered:true})},removeMyContribDialog:function(){var b=a.tmpl(this.templates.removeLaneContrib,{title:m.currentLane.title});b.find(".removeConfirm").bind(m.clickOrTouchEnd,
function(){a.ajax({type:"delete",url:"/lanes/contributor",data:{lane_id:m.currentLane.id,username:m.currentUser.username},success:function(){f.location.reload()}});return false});b.lightbox_me({centered:true})},addLaneView:function(){var b=this;this.showDrawerLoader();this.urlHashObject.drawer==="open"&&_.delay(a.proxy(this.openDrawer,this),1E3);var c=a.tmpl(this.templates.drawerView,m.currentLane).html();this.currentUserIsOwner&&(this.$drawerContent.height(this.$drawerContent.height()-43),this.$drawerContent.after(this.templates.editLaneAction));
!this.currentUserIsOwner&&this.currentUserIsContributor&&(this.$drawerContent.height(this.$drawerContent.height()-43),this.$drawerContent.after(this.templates.removeContribAction));this.hideDrawerLoader();this.showDrawerContent();this.$drawerContent.find(".jspPane").append(c).end().data("jsp").reinitialise();a("#drawer-edit-lane-link").bind(m.clickOrTouchStart,function(){b.hideDrawerContent();b.$drawerContent.height(b.$drawerContent.height()+43).find(".jspPane").empty();a("#drawer-actions").remove();
b.addEditView();m.utilities.urlHash.go(m.utilities.urlHash.set("drawer=edit"));return false});a("#remove-my-memos-link").bind(m.clickOrTouchStart,function(){b.removeMyContribDialog();return false})},showDrawerLoader:function(){this.$drawer.addClass("small-loader-on-grey")},hideDrawerLoader:function(){this.$drawer.removeClass("small-loader-on-grey")},hideDrawerContent:function(){this.$drawerContent.addClass("visibility-hidden")},showDrawerContent:function(){this.$drawerContent.removeClass("visibility-hidden")},
openDrawer:function(){if(!this.drawerIsOpen)this.drawerIsOpen=true,this.$headerLaneTitle.hide(),a("#screenLeftBtn,#screenRightBtn").trigger("mouseout"),this.$screenLeftBtn.stop().animate({left:this.$drawer.outerWidth()},400,"easeOutCubic"),this.$drawer.stop().animate({left:"0"},400,"easeOutCubic"),this.$slotLoaderLeft.stop().animate({left:this.$drawer.outerWidth()},400,"easeOutCubic"),a("#openMemo").length&&m.memos.rePositionOpenedMemo(),this.$drawerHandlerIcon.animate({rotate:"+=180deg"},500)},closeDrawer:function(b,
c,d){var b=b||200,e=Modernizr.sessionstorage?sessionStorage.getItem("drawerAware")?0:500:0;this.drawerIsOpen=false;this.$headerLaneTitle.show();this.$screenLeftBtn.stop().animate({left:"0px"},200,"easeOutCubic");this.$slotLoaderLeft.stop().animate({left:0},200,"easeOutCubic");this.$drawer.stop().animate({left:-this.$drawer.outerWidth()},b,"easeOutCubic",c||jQuery.noop());a("#openMemo").length&&m.memos.rePositionOpenedMemo();this.$drawerHandlerIcon.animate({rotate:"-=180deg"},e);if(a(d).is("#lane-drawer-tab")||
a(d).closest("#lane-drawer-tab").length===1)f.location.hash=""},onClickOrTouchStart:function(a){this.drawerIsOpen?this.closeDrawer(200,null,a.target):this.openDrawer();return false},templates:
{drawerView:'<div>侧边功能正在开发中...</div>'}
}}(this,
jQuery,this.undefined);m.drawer.initialize();
m.laneNavBtns=function(f,a){return{$screenLeftBtn:a("#screenLeftBtn"),$screenRightBtn:a("#screenRightBtn"),$screenBtn:a("#screenLeftBtn,#screenRightBtn"),initialize:function(){this.$screenBtn.bind(m.mouseOverOrTouchStart,this.onMouseOverOrTouchStart).bind(m.mouseOutOrTouchEnd,this.onMouseOutOrTouchEnd);this.$screenLeftBtn.bind(m.clickOrTouchStart,this.onClickLeftBtn);this.$screenRightBtn.bind(m.clickOrTouchStart,this.onClickRightBtn);a(document).keyup(function(b){switch(b.which){case 37:a("#screenLeftBtn").trigger("click");break;
case 39:a("#screenRightBtn").trigger("click")}})},onMouseOverOrTouchStart:function(){a(this).stop().animate({width:"50px",opacity:0.9},100,"swing");return false},onMouseOutOrTouchEnd:function(){if(a("#slot-loader-left").is(":visible")||a("#slot-loader-right").is(":visible"))return false;a(this).stop().animate({width:"25px",opacity:0.6},100,"swing");return false},onClickLeftBtn:function(){if(a(this).is(":hidden")||m.lane.cancelLaneMovement===true)return false;var b=a("#lane-viewport"),c=b.scrollLeft(),
d=m.drawer.drawerIsOpen?a("#lane-drawer").width():0;if(c<=0)return false;m.lane.moveLane({xpos:c-(b.width()-d),animate:true});return false},onClickRightBtn:function(){if(a(this).is(":hidden")||m.lane.cancelLaneMovement===true)return false;var b=a("#lane-viewport"),c=b.scrollLeft(),d=m.drawer.drawerIsOpen?a("#lane-drawer").width():0;if(c>=a("#lane").width())return false;m.lane.moveLane({xpos:c+(b.width()-d),animate:true});return false}}}(this,jQuery,this.undefined);m.laneNavBtns.initialize();
m.lane=function(f,a){return{$laneViewport:a("#lane-viewport"),$lane:a("#lane"),$content:a("#content"),$screenLeftBtn:a("#screenLeftBtn"),$screenRightBtn:a("#screenRightBtn"),$laneViewportAndLanNav:a("#lane-viewport,.screenBtn"),currentlyCenteredLaneMemoTime:"",cancelLaneMovement:false,initialize:function(){this.$laneViewport.bind(m.mouseDownOrTouchStart,this.onMouseDownOrTouchStart).bind(m.mouseUpOrTouchEnd,this.onMouseUpOrTouchEnd).bind(m.mouseMoveOrTouchMove,a.proxy(this.onMouseMoveOrTouchMove,
this)).bind("mouseleave",this.onMouseUpOrTouchEnd).mousewheel(a.proxy(this.onMouseWheel,this));a("#favorite-un-fav").bind(m.clickOrTouchEnd,this.favUnFavLane)},moveLane:function(a){if(this.cancelLaneMovement===true)return false;var c=this;a.animate?(this.cancelLaneMovement=true,this.$laneViewport.stop().animate({scrollLeft:a.xpos},1E3,"easeOutCubic",function(){c.moveLaneComplete()})):(this.$laneViewport.scrollLeft(a.xpos),this.moveLaneComplete());this.updateCurrentlyCenteredLaneMemoTime();m.timeline.showFixedIndicatorByTimestamp()},
moveLaneComplete:function(){this.loadMoreMemos();this.updateCurrentlyCenteredLaneMemoTime();m.timeline.showFixedIndicatorByTimestamp();this.onLaneEndRemoveNavBtn();this.cancelLaneMovement=false},moveLaneToMemo:function(b){b=a("#"+b).offset().left;b=b<0?this.$laneViewport.scrollLeft()-Math.abs(b):this.$laneViewport.scrollLeft()+b;this.moveLane({xpos:Math.round(b-(a("#lane-viewport").width()/2-100))})},updateCurrentlyCenteredLaneMemoTime:function(){var b=this;a(".memo").each(function(){var c=a(this).offset().left,
c=c<0?b.$laneViewport.scrollLeft()-Math.abs(c):b.$laneViewport.scrollLeft()+c;if(c>=a("#lane-viewport").scrollLeft()+a("#lane-viewport").width()/2)return b.currentlyCenteredLaneMemoTime=a(this).data("time"),false})},trimLaneLeft:function(){var b=a("#lane-viewport").width(),c=b*3,d=0;a("#lane .lane-slot").each(function(){var e=a(this);e.offset().left<0&&Math.abs(e.offset().left)>c&&e.width()<c-b&&(e.addClass("removeSlot"),d+=e.width())});if(d>0){var e=this.$laneViewport.scrollLeft();a(".removeSlot").remove();
this.$lane.width(a("#lane").width()-d);this.$laneViewport.scrollLeft(e-d)}},trimLaneRight:function(){var b=a("#lane-viewport").width(),c=b*3,d=0;a("#lane .lane-slot").each(function(){var e=a(this);e.offset().left>c&&e.width()<c-b&&(e.addClass("removeSlot"),d+=e.width())});d>0&&(a(".removeSlot").remove(),this.$lane.width(a("#lane").width()-d))},loadMoreMemos:function(){var b=a("#lane-viewport"),c=parseInt(a("#content .memo").first().data("time")),d=parseInt(a("#content .memo").last().data("time"));
c!=m.currentLane.first_memo&&b[0].scrollLeft<b.width()*2&&m.laneLoadMemos.loadMemosLeft();d!=m.currentLane.last_memo&&b[0].scrollWidth-b[0].scrollLeft<b.width()*2&&m.laneLoadMemos.loadMemosRight()},onMouseDownOrTouchStart:function(b){if(!a(b.target).closest(".openMemo").length){if(b.originalEvent.touches||b.originalEvent.changedTouches)var c=b.originalEvent.touches[0]||b.originalEvent.changedTouches[0];a(this).data("down",true).data("x",b.pageX||c.pageX).data("scrollLeft",this.scrollLeft).data("currentMouseX",
b.pageX||c.pageX).data("currentMouseY",b.pageY||c.pageX).css("cursor","ew-resize");b.preventDefault()}},onMouseUpOrTouchEnd:function(b){a("#lane-viewport").data("down",false).css("cursor","default");a(".memo").css("cursor","pointer");f.setTimeout(function(){a("#lane-viewport").data("drag",false)},100);b.stopPropagation()},onMouseMoveOrTouchMove:function(b){var c=a(b.currentTarget);if(b.originalEvent.touches||b.originalEvent.changedTouches)var d=b.originalEvent.touches[0]||b.originalEvent.changedTouches[0];
if(this.$laneViewport.data("down")===true){var e=b.pageX-c.data("currentMouseX"),g=b.pageY-c.data("currentMouseY");Math.abs(e)+Math.abs(g)>5&&(this.$laneViewport.data("drag",true),a(".memo").css("cursor","ew-resize"));this.moveLane({xpos:c.data("scrollLeft")+c.data("x")-(b.pageX||d.pageX)})}return false},onMouseWheel:function(b,c){if(this.cancelLaneMovement===true)return false;a(b.target).closest(".openMemo").length!==1&&m.lane.moveLane({xpos:b.currentTarget.scrollLeft-=c*30})},onLaneEndRemoveNavBtn:function(){this.$laneViewport.scrollLeft()===
0?this.$screenLeftBtn.hide():this.$screenLeftBtn.show();this.$laneViewport.scrollLeft()+this.$laneViewport.width()===a("#lane").width()?this.$screenRightBtn.hide():this.$screenRightBtn.show()},hideLane:function(){this.$laneViewportAndLanNav.css("visibility","hidden")},showLane:function(){this.$laneViewportAndLanNav.css("visibility","visible")},hideLaneLoader:function(){this.$content.removeClass("lane-load")},
//showLaneLoader:function(){this.$content.addClass("lane-load")},
favUnFavLane:function(){var b=
a(this);b.data("fav")===false?a.ajax({url:"/lanes/favorite",type:"POST",data:{lane_id:m.currentLane.id}}).success(function(){b.attr("title","Un-favorite lane").data("fav","true");b.addClass("favorited")}):a.ajax({url:"/lanes/favorite",type:"DELETE",data:{lane_id:m.currentLane.id}}).success(function(){b.attr("title","Favorite lane").data("fav",false);b.removeClass("favorited")});return false}}}(this,jQuery,this.undefined);m.lane.initialize();
m.memos=function(f,a){return{$memo:a(".memo"),$laneViewport:a("#lane-viewport"),memoStore:{},initialize:function(){this.$laneViewport.delegate(".memo",m.clickOrTouchEnd,a.proxy(this.openMemo,this));this.$laneViewport.delegate(".closeOpenMemo",m.clickOrTouchEnd,a.proxy(this.closeMemo,this));this.$laneViewport.delegate(".memoAvatar",m.clickOrTouchEnd,a.proxy(this.goToMemoOwnersDashboard,this));this.$laneViewport.delegate(".music-play-btn",m.clickOrTouchEnd,a.proxy(this.handleMusicClick,this))},goToMemoOwnersDashboard:function(a){a.stopPropagation()},
openMemo:function(b){var c=this;if(this.$laneViewport.data("drag"))return this.$laneViewport.data("drag",false),false;var d=a(".openMemo");if(d.length){a(".largeMemoDialog .close").click();var e=d.data("memoOpenInfo");d.add(".memoGhost").addClass("memoClosing");_.size(e)?a(".memoClosing").animate({height:e.memoH,width:e.memoW,top:e.memoY,left:e.memoX},400,"easeInExpo",function(){e.memo.css("visibility","visible");a(this).remove()}):(a(".memoClosing").remove(),a(".memo").css("visibility","visible"))}var g=
a(b.currentTarget),h=this.memoStore[g.attr("id")],b=this.$laneViewport.append(a.tmpl(this.templates.largeMemos[h.service]?this.templates.largeMemos[h.service]:this.templates.largeMemos["default"],h)).find(".openMemo").filter(":last"),d=a(".openMemo:not(.memoClosing) .largeMemoFooterBar");d.find(".memo_privacy").bind(m.clickOrTouchEnd,function(){c.setMemoPrivacyDialog(h);return false});d.find(".memo_laneAdd").bind(m.clickOrTouchEnd,function(){c.addMemoToLaneDialog(h);return false});d.find(".memo_laneRemove").bind(m.clickOrTouchEnd,
function(){c.removeMemoFromLaneDialog(h);return false});var f=a("#lane-viewport").height()-20,d=a("#lane-viewport").width(),k=a(".openMemo:not(.memoClosing)").outerWidth(true);a(".openMemo:not(.memoClosing)").outerHeight(true);k>d&&(k=d,a(".openMemo:not(.memoClosing)").width(d).css("max-width",d));b.find(".memoMapContainer").length&&this.handleMapMemos();a(".openMemo:not(.memoClosing) .largeMemoContent img").length?a(".largeMemoContent img").imagesLoaded(function(){a(".openMemo:not(.memoClosing) .lrgMemoImg").length?
c.renderMemoWithFittedImgDimensions(g,f):c.renderMemoDimensions(g,f)}):this.renderMemoDimensions(g,f)},renderMemoDimensions:function(b,c){this.shrinkLargeMemoWhitespace();var d=a(".openMemo:not(.memoClosing)").outerWidth(true),e=a(".openMemo:not(.memoClosing)").outerHeight(true),g=a(".openMemo:not(.memoClosing)");g.height()>c&&(e=g.find(".largeMemoTitleBar").outerHeight(true)+g.find(".largeMemoFooterBar").outerHeight(true),g.find(".largeMemoContent").css("height",Math.floor(c-e)),e=c);var g=this.$laneViewport.scrollLeft(),
h=this.$laneViewport.width()/2-d/2,f=this.$laneViewport.height()/2-e/2,k=(m.drawer.drawerIsOpen?a("#lane-drawer").width():0)/2;b.css("visibility","hidden");a(".openMemo:not(.memoClosing), .memoGhost").css({left:b.offset().left+g-10,top:b.position().top+25}).height(b.height()).width(b.width()).show().filter(".openMemo").css("visibility","visible").data("memoOpenInfo",{memoX:b.offset().left+g-10,memoY:b.position().top+25,memoH:b.height(),memoW:b.width(),memo:b}).animate({height:e,width:d,top:f,left:h+
g+k-12},500,"easeOutExpo")},renderMemoWithFittedImgDimensions:function(b,c){var d=a(".openMemo:not(.memoClosing)");d.width();var e=d.height(),g=d.find(".largeMemoTitleBar").outerHeight(true)+d.find(".largeMemoFooterBar").outerHeight(true),h=d.find(".largeMemoContent").outerHeight(true)-d.find(".largeMemoContent img").outerHeight(true),f=d.find(".lrgMemoImg img:first");f.width();f.height();e>c&&(e=Math.floor(c-g-h),e<50&&(e=50),d.find(".largeMemoContent img").attr("height",e));a(".openMemo:not(.memoClosing)").outerHeight(true)>
c&&a(".openMemo:not(.memoClosing)").height(c).css("max-height",c);this.shrinkLargeMemoWhitespace();var d=a(".openMemo:not(.memoClosing)").outerWidth(true),e=a(".openMemo:not(.memoClosing)").outerHeight(true),g=this.$laneViewport.scrollLeft(),h=this.$laneViewport.width()/2-d/2,f=this.$laneViewport.height()/2-e/2,k=(m.drawer.drawerIsOpen?a("#lane-drawer").width():0)/2;b.css("visibility","hidden");a(".openMemo:not(.memoClosing), .memoGhost").css({left:b.offset().left+g-10,top:b.position().top+25}).height(b.height()).width(b.width()).show().filter(".openMemo").css("visibility",
"visible").data("memoOpenInfo",{memoX:b.offset().left+g-10,memoY:b.position().top+25,memoH:b.height(),memoW:b.width(),memo:b}).animate({height:e,width:d,top:f,left:h+g+k-12},500,"easeOutExpo")},shrinkLargeMemoWhitespace:function(){},closeMemo:function(){a(".largeMemoDialog .close").click();var b=a(".openMemo:first").data("memoOpenInfo");_.size(b)?a(".openMemo:first").animate({height:b.memoH,width:b.memoW,top:b.memoY,left:b.memoX},400,"easeInExpo",function(){b.memo.css("visibility","visible");a(".openMemo, .memoGhost").remove()}):
(a(".openMemo:first").remove(),a(".memo").css("visibility","visible"))},rePositionOpenedMemo:function(){var b=a(".openMemo"),c=(m.drawer.drawerIsOpen?a("#lane-drawer").width():0)/2,d=b.width(),e=b.height(),d=this.$laneViewport.width()/2-d/2,e=(this.$laneViewport.height()+25)/2-e/2;b.css({top:e,left:d+this.$laneViewport.scrollLeft()+c-12})},setMemoPrivacyDialog:function(b){var c=a.tmpl(this.templates.dialogs.setPrivacy,b);c.find("#"+b.privacy).addClass("smallButtonActive");c.find("#"+b.privacy+"TabDescription").css("display",
"block");c.find(".smallButtonBar li a").bind("mouseenter mouseleave ",function(b){var e=a(this).attr("id");b.type=="mouseenter"?(a(".privacyTabDescription div").hide(),a("#"+e+"TabDescription").show()):c.find(".smallButtonActive").length?(a(".privacyTabDescription div").hide(),b=c.find(".smallButtonActive").attr("id"),a("#"+b+"TabDescription").show()):a(".privacyTabDescription div").hide()});c.find(".smallButtonBar li a").bind(m.clickOrTouchEnd,function(){var d=this;a.ajax({type:"post",url:"/memos/"+
encodeURIComponent(b.id)+"/privacy",data:{privacy:a(d).attr("id")},success:function(){var e=c.find(".smallButtonActive").attr("id"),g=a(d).attr("id");c.find("#"+e).removeClass("smallButtonActive");c.find("#"+e+"TabDescription").hide();c.find("#"+g).addClass("smallButtonActive");c.find("#"+g+"TabDescription").show();a(".openMemo .memo_"+e).removeClass("memo_"+e).addClass("memo_"+g);var h=m.utilities.cleanMemoId(b.id);a("#"+h).find(".memo_privacy").removeClass("memo_"+e).addClass("memo_"+g);m.memos.memoStore[h].privacy=
g}})});c.lightbox_me({destroyOnClose:true})},addMemoToLaneDialog:function(b){var c=this,d=a.tmpl(this.templates.dialogs.addMemoToLane.loading,b);d.lightbox_me({destroyOnClose:true});a.ajax({type:"get",url:"/memos/"+b.id+"/can_be_added_to",success:function(e){var g={};g.lanes=e;e=a.tmpl(c.templates.dialogs.addMemoToLane.loaded,g).html();d.find(".dialogContent").html(e);d.trigger("reposition");d.find(".addMemoToLane").bind(m.clickOrTouchEnd,function(c){var d=a(this).parent();d.html("Adding...");a.ajax({type:"post",
url:"/lanes/include_memo",data:{lane_id:a(this).attr("id"),memo_id:b.id},success:function(){d.html("Added!")}});c.preventDefault()})}})},removeMemoFromLaneDialog:function(b){var c=this,d=a.tmpl(this.templates.dialogs.removeMemoFromLane,b);d.find(".removeMemoConfirm").bind(m.clickOrTouchEnd,function(d){a.ajax({type:"delete",url:"/lanes/include_memo",data:{lane_id:m.currentLane.id,memo_id:b.id},success:function(){c.closeMemo();var d=m.utilities.cleanMemoId(b.id);a("#"+d).remove();delete m.memos.memoStore[d]}});
d.preventDefault()});d.lightbox_me({destroyOnClose:true})},handleMapMemos:function(){var b=a(".openMemo").filter(":last"),c=b.find(".memoMapContainer");if(c.length){var d=m.memos.memoStore[b.data("memo-id")].doc.geo,b=d.poi,e=(d=d.polyline)||_.size(b)>1?true:false;if(e)var g=d?Number(d[0].lat):Number(b[0].lat),h=g,f=d?Number(d[0].lon):Number(b[0].lon),k=f;var n={zoom:14,center:new google.maps.LatLng(b[0].lat,b[0].lon),disableDefaultUI:true,mapTypeControl:false,draggable:true,scrollwheel:false,mapTypeId:google.maps.MapTypeId.ROADMAP},
c=new google.maps.Map(c.get(0),n);if(b)for(i in n=function(a,b,c,d){google.maps.event.addListener(b,"click",function(){var e=new google.maps.InfoWindow,g='<div style="line-height:16px;">';g+='<strong style="font-size:15px; line-height:18px;">'+d.name+"</strong>";d.description&&(g+='<br style="line-height:24px;" />'+d.description);g+="</div>";e.setContent(g);e.setPosition(c);e.open(a,b)})},b){var l=b[i];e&&(l.lat<g?g=Number(l.lat):l.lat>h&&(h=Number(l.lat)),l.lon<f?f=Number(l.lon):l.lon>k&&(k=Number(l.lon)));
var p=new google.maps.LatLng(l.lat,l.lon),r=new google.maps.Marker({position:p});n(c,r,p,l);r.setMap(c)}if(d){b=[];for(j in d)e&&(d[j].lat<g?g=Number(d[j].lat):d[j].lat>h&&(h=Number(d[j].lat)),d[j].lon<f?f=Number(d[j].lon):d[j].lon>k&&(k=Number(d[j].lon))),b.push(new google.maps.LatLng(d[j].lat,d[j].lon));(new google.maps.Polyline({path:b,strokeColor:"#FD7768",strokeOpacity:1,strokeWeight:4})).setMap(c)}e&&(g=new google.maps.LatLng(g,f),h=new google.maps.LatLng(h,k),h=new google.maps.LatLngBounds(g,
h),c.fitBounds(h))}},setWidthAndHeightInMemoContent:function(b,c,d,e){c=c?c:585;d=d?d:390;e||(e=1.5);var g=e/1,f=c,o=d,k=a("#lane-viewport").width(),n=a("#lane-viewport").height()-20-61;k<f&&(f=k);n<o&&(o=n);if(f<c||o<d)o*e>=f?o=f*g:f=o*e;b=b.replace(/__WIDTH__/gi,f);b=b.replace(/__HEIGHT__/gi,o);return b=this.setWmodeInVideoMemos(b)},setWmodeInVideoMemos:function(b){return a("<div>").append(b).find("object, embed").attr("wmode","transparent").end().html()},handleMusicClick:function(b){var c=a(b.currentTarget),
d=c.text(),e=c.data("track-name"),g=c.data("artist-name"),f="amazon",o="/utils/amazon_url";m.currentUser&&m.currentUser.music_provider=="spotify"&&(f="spotify",o="/utils/spotify_url");var k=function(){c.replaceWith('<span style="color:red; font-weight:bold;">Service currently unavailable.</span>')};c.text("Loading...");a.ajax({url:o,data:{artist:g,track:e},dataType:"text",error:function(){k()},success:function(a){a!='""'?(c.text(d),f=="spotify"?window.location.href=a:window.open(a,"amazon")):k()}});
b.preventDefault()},templates:{
    largeMemos:{
},
dialogs:{setPrivacy:'<div id="privacyDialog" class="memolaneDialog largeMemoDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Set Privacy</div>\t\t<div class="close closeMemolaneDialog">close</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<h2 class="${service}"></h2>\t\t<a href="#" class="close" id="setPrivacyDone" style="display:none;">Close</a>\t\t<p>The privacy setting you select for this memo will be uniformly applied to all lanes on which it exists. Your choice here will override your service-level setting.</p>\t\t<p>Please choose a setting to continue:</p>\t\t<ul class="privacyTabs smallButtonBar">\t\t\t<li><a href="#" id="public">Public</a></li>\t\t\t<li><a href="#" id="friends">Friends Only</a></li>\t\t\t<li><a href="#" id="private">Private</a></li>\t\t</ul>\t\t<div class="privacyTabDescription">\t\t\t<div id="publicTabDescription"><h3>Public</h3><p>This memo will be visible to everyone who visits your Memolane.</p></div>\t\t\t<div id="friendsTabDescription"><h3>Friends Only</h3><p>This memo will only be visible to your Memolane friends visiting your Memolane.</p></div>\t\t\t<div id="privateTabDescription"><h3>Private</h3><p>This memo will only be visible to you on your Memolane.</p></div>\t\t</div>\t</div></div>',
addMemoToLane:{loading:'<div id="removeMemoDialog" class="memolaneDialog largeMemoDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Add a memo to a lane</div>\t\t<div class="close closeMemolaneDialog">close</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<h2 class="header typeJ" style="text-align:center; margin-bottom:0;"><img src="/img/common/smallLoaderOnWhite.gif" alt="loading lanes..." /></h2>\t</div></div>',loaded:'<div><p>Adding a memo to a lane keeps it on the lane even if the service it is streamed from is removed - streaming rules are set in the <a href="#" class="openDrawerEditViewOnClick">lane drawer edit view</a>. You can add an individual memo to any lane shown below, including the lane you are viewing this memo on:</p><div id="laneListScroller"><ul class="lane-list">\t{{each lanes}}\t\t<li>\t\t\t<img src="{{if avatar_url}}${avatar_url}{{else}}/lanes/${id}/avatar{{/if}}" class="float-left" alt="lane avatar" />\t\t\t${title}\t\t\t<div class="float-right addMemoStatus">\t\t\t\t{{if already_included}}\t\t\t\t\tAdded\t\t\t\t{{else}}\t\t\t\t\t<a href="#" id="${id}" class="btn-green addMemoToLane">Add</a>\t\t\t\t{{/if}}\t\t\t</div>\t\t</li>\t{{/each}}</ul></div></div>'},
removeMemoFromLane:'<div id="removeMemoDialog" class="memolaneDialog largeMemoDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Remove memo from lane</div>\t\t<div class="close closeMemolaneDialog">cancel</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<h2 class="header typeJ">Whoa, are you sure?</h2>\t\t<p>This will NOT remove this memo from any other lane(s) on which it appears.</p>\t\t<p><a href="#" class="btn-red float-left removeMemoConfirm close">Yes, remove this memo from this lane</a> <a href="#" class="secondaryAction float-left close">No, I don\'t want that</a></p>\t</div></div>'}}}}(this,
jQuery,this.undefined);m.memos.initialize();
m.laneLoadMemos=function(f,a){return{$laneViewport:a("#lane-viewport"),$lane:a("#lane"),$laneSlot:a(".lane-slot"),urlHashObjectOnPageLoad:m.utilities.urlHash.get(),preloadingLeft:false,preloadingRight:false,numberOfMemosToLoad:Math.round(a("body").width()/250*(a("#lane-viewport").height()/250))*4,initialize:function(){this.loadLaneOnThisTime=this.urlHashObjectOnPageLoad.time?this.urlHashObjectOnPageLoad.time:Math.round((new Date).getTime()/1E3);m.currentLane.mode!=="new"&&(m.currentLane.total_memos===
0||m.currentLane.visible_memos===0?(a("#lane-drawer").css("visibility","visible"),m.drawer.openDrawer()):(m.lane.showLaneLoader(),this.initialLoadMemos()))},initialLoadMemos:function(){var b=this;a.ajax({url:"/lanes/"+m.currentLane.id+"/memos",data:{timestamp:this.loadLaneOnThisTime,left:b.numberOfMemosToLoad,right:b.numberOfMemosToLoad,public_only:m.isEmbedded}}).success(function(c){var d=c[0].created_at-c[0].created_at%86400,e=c[c.length-1].created_at-c[c.length-1].created_at%86400+86400;d===e&&
(e+=86399);d=b.createSlotsAndMemos(d,e,c,86400);b.$lane.empty().append(d);a(".lane-slot-memos").find("img:not([height])").imagesLoaded(function(){m.laneLayout.runLayout();m.lane.hideLaneLoader();m.lane.showLane();m.lane.moveLaneToMemo(b.getMemoIdClosesToTime(c,b.loadLaneOnThisTime));b.updateMemoStore(c);b.urlHashObjectOnPageLoad.memo&&b.deepLinkToMemo()})})},deepLinkToMemo:function(){var b=this;f.setTimeout(function(){a("#"+b.urlHashObjectOnPageLoad.memo).trigger("click")},500)},getMemoIdClosesToTime:function(a,
c){var d=0,e=m.utilities.cleanMemoId,g,f=a.length;if(a[f-1].created_at<=c)g=e(a[f-1].id);else for(;d<f;){if(a[d].created_at>=c){a[d].created_at==c?g=e(a[d].id):(g=Math.abs(a[d].created_at-c),f=Math.abs(a[d===0?0:d-1].created_at-c),g=g>f?e(a[d-1].id):e(a[d].id));break}d++}return g},createSlotsAndMemos:function(b,c,d,e){for(var g="",f=this.templates.smallMemos;b<c;){var o="",k=_.select(d,function(a){return a.created_at>b&&a.created_at<b+e});k.length&&(_.each(k,function(b){o+=f[b.service]?a.tmpl(f[b.service],
b).html():a.tmpl(f["default"],b).html()}),g+='<div class="lane-slot" id="'+b+'">\t<div class="lane-circle"></div>\t<div class="lane-slot-title">'+m.utilities.dateFormat(b*1E3,"UTC:ddd, yyyy-mm-dd")+'</div>\t<div class="lane-slot-memos">'+o+"</div></div>");b+=e}return g},getHTMLForNewMemos:function(a){if(a.length===0)return"";var c=a[0].created_at-a[0].created_at%86400,d=a[a.length-1].created_at-a[a.length-1].created_at%86400;c===d&&(d+=86399);return this.createSlotsAndMemos(c,d,a,86400)},getUpdatedHTMLforNewMemos:function(b,
c,d){if(b.length===0)return"";var e=m.laneLoadMemos.templates.smallMemos,f="";_.each(b,function(b){var c="";c+=e[b.service]?a.tmpl(e[b.service],b).html():a.tmpl(e["default"],b).html();f+=c});return a("#lane .lane-slot")[c]().clone().find(".lane-slot-memos")[d](f).end().clone()},loadMemosRight:function(){if(this.preloadingRight)return false;var b=this;this.preloadingRight=true;a.ajax({url:"/lanes/"+m.currentLane.id+"/memos",data:{timestamp:a(".memo").last().data("time")+1,right:b.numberOfMemosToLoad,
public_only:m.isEmbedded}}).success(function(c){if(c.length===0)return false;c.length!=1&&c.shift();var d=a(".lane-slot"),e=a(".lane-slot").last(),g=a("#lane");lastSlotTime=parseInt(d.last().attr("id"));secondsInDay=86400;$laneViewport=a("#lane-viewport");$preMemoRight=a("#preMemoRight");$screenRightBtn=a("#screenRightBtn");$slotLoaderRight=a("#slot-loader-right");memosForSlot=_.select(c,function(a){return a.created_at>lastSlotTime&&a.created_at<lastSlotTime+secondsInDay});memosNoSlotYet=_.select(c,
function(a){return a.created_at>lastSlotTime+secondsInDay});memosForSlotHtml=b.getUpdatedHTMLforNewMemos(memosForSlot,"last","append");oldWidthBeforeUpdate=a("#lane .lane-slot-memos").last().width();memoNoSlotYetHtml=b.getHTMLForNewMemos(memosNoSlotYet);$preMemoRight.append(memosForSlotHtml).append(memoNoSlotYetHtml).find(".lane-slot-memos").height(g.find(".lane-slot-memos").height()).end().find(".lane-slot-memos").isotope({layoutMode:"fitColumns",animationEngine:"jquery",animationOptions:{duration:0,
queue:false}});b.rightContentLoaded=true;var h=f.setInterval(function(){if($laneViewport[0].scrollLeft+$laneViewport.width()>=$laneViewport[0].scrollWidth){clearInterval(h);$slotLoaderRight.show();$screenRightBtn.hide();$laneViewport.stop().trigger(m.mouseUpOrTouchEnd);m.lane.cancelLaneMovement=true;var c=f.setInterval(function(){if(b.rightContentLoaded){clearInterval(c);var d=a(".openMemo"),f=0;$preMemoRight.find(".lane-slot").each(function(){f+=a(this).width()});var h=$preMemoRight.html();memosForSlot.length?
(g.width(g.width()+f-(oldWidthBeforeUpdate+40)),e.remove(),g.append(h),d.length&&d.css("left",d[0].offsetLeft+(f-(oldWidthBeforeUpdate+40)))):(g.width(g.width()+f),g.append(h),d.length&&d.css("left",d[0].offsetLeft+f));$preMemoRight.children().remove();$slotLoaderRight.hide();m.lane.cancelLaneMovement=false;$laneViewport.stop();$screenRightBtn.show();b.updateMemoStore(memosForSlot);b.updateMemoStore(memosNoSlotYet);m.lane.trimLaneLeft();b.preloadingRight=false}},500)}else if($laneViewport[0].scrollLeft<
$laneViewport[0].scrollWidth-$laneViewport.width()*3)clearInterval(h),b.preloadingRight=false,$preMemoRight.empty()},500)})},loadMemosLeft:function(){if(this.preloadingLeft)return false;var b=this;this.preloadingLeft=true;a.ajax({url:"/lanes/"+m.currentLane.id+"/memos",data:{timestamp:a(".memo").first().data("time")-1,left:b.numberOfMemosToLoad,public_only:m.isEmbedded}}).success(function(c){if(c.length===0)return false;c.length!=1&&c.pop();var d=a(".lane-slot"),e=a(".lane-slot").first(),g=a("#lane"),
h=parseInt(d.eq(0).attr("id")),o=a("#lane-viewport"),k=a("#preMemoLeft"),n=a("#screenLeftBtn"),l=a("#slot-loader-left"),p=_.select(c,function(a){return a.created_at>h&&a.created_at<h+86400}),r=_.select(c,function(a){return a.created_at<h}),c=b.getUpdatedHTMLforNewMemos(p,"first","prepend"),q=a("#lane .lane-slot-memos").first().width(),d=b.getHTMLForNewMemos(r);a("#preMemoLeft").append(c).prepend(d).find(".lane-slot-memos").height(g.find(".lane-slot-memos").height()).end().find(".lane-slot-memos").isotope({layoutMode:"fitColumns",
animationEngine:"jquery",animationOptions:{duration:0,queue:false}});b.leftContentLoaded=true;var s=f.setInterval(function(){if(o.scrollLeft()<=0){clearInterval(s);l.show();n.hide();o.stop().trigger(m.mouseUpOrTouchEnd);m.lane.cancelLaneMovement=true;var c=f.setInterval(function(){if(b.leftContentLoaded){clearInterval(c);var d=a(".openMemo"),f=0;k.find(".lane-slot").each(function(){f+=a(this).width()});var h=k.html();p.length?(g.width(g.width()+f-(q+40)),e.remove(),g.prepend(h),o.scrollLeft(f-(q+
40)),d.length&&d.css("left",d[0].offsetLeft+(f-(q+40)))):(g.width(g.width()+f),g.prepend(h),o.scrollLeft(f),d.length&&d.css("left",d[0].offsetLeft+f));k.children().remove();l.hide();m.lane.cancelLaneMovement=false;o.stop();n.show();b.updateMemoStore(p);b.updateMemoStore(r);m.lane.trimLaneRight();b.preloadingLeft=false}},500)}else if(o[0].scrollLeft>=o.width()*3)clearInterval(s),b.preloadingLeft=false,k.empty()},500)})},updateMemoStore:function(a){var c=a.length;if(c===0)return false;for(var d=m.memos.memoStore,
e=m.utilities.cleanMemoId,f=0;f<c;)d[e(a[f].id)]=a[f],f++},googleMapImageURL:function(b){var c=0,d=0,e="&markers=color:0x1587C8|size:small|";a.each(b.poi,function(a,b){e+=b.lat+","+b.lon+"|";c++});var e=e.slice(0,-1),f="";b.polyline&&(f="&path=color:0xE5831A|weight:3|",a.each(b.polyline,function(a,b){f+=b.lat+","+b.lon+"|";d++}),f=f.slice(0,-1));b="";d==0&&c==1&&(b="&zoom=14");return"http://maps.google.com/maps/api/staticmap?size=200x150"+b+"&sensor=false"+e+"&maptype=roadmap"+f},mapquestMapImageURL:function(b){var c=
0,d=0,e="&pois=";a.each(b.poi,function(a,b){e+="blue,"+b.lat+","+b.lon+"|";c++});var e=e.slice(0,-1),f="";b.polyline&&(f="&polyline=color:0xE5831A|width:3|",a.each(b.polyline,function(a,b){f+=b.lat+","+b.lon+",";d++}),f=f.slice(0,-1));var h="&bestfit=";d==0&&c==1&&(h="&zoom=10&center="+b.poi[0].lat+","+b.poi[0].lon);return"http://www.mapquestapi.com/staticmap/v3/getmap?key=Fmjtd%7Cluu2nu0tn5%2C8x%3Do5-h01x9"+h+"&size=200,150&type=map&imagetype=jpeg&scalebar=false"+e+f},templates:{smallMemos:{"default":'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo ${service}" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source{{if doc && doc.author && doc.author.name}} (by ${doc.author.name}){{/if}}"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon" {{if doc && doc.author && doc.author.name}}title="By ${doc.author.name}"{{/if}}></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t<div class="memoContent">\t\t{{if doc && doc.image && doc.image.thumbnail}}\t\t\t<img src="${doc.image.thumbnail}" />\t\t{{else}}\t\t\t{{if doc && doc.title && doc.title.text}}\t\t\t\t<p>${doc.title.text}</p>\t\t\t{{/if}}\t\t{{/if}}\t</div>\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
facebook:'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo facebook" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon"></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t{{if doc.sub_type == "photo"}}\t\t{{if doc.image.sizes && doc.image.sizes.url}}\t\t\t{{if doc.image.sizes.url.width <= 200}}\t\t\t\t<div class="memoContent" style="height:${doc.image.sizes.url.height}px;">\t\t\t\t\t<img src="${doc.image.url}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t\t</div>\t\t\t{{else}}\t\t\t\t<div class="memoContent" style="height:${Math.round((doc.image.sizes.url.height/doc.image.sizes.url.width)*200)}px;">\t\t\t\t\t<img style="width:200px;" src="${doc.image.url}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t\t</div>\t\t\t{{/if}}\t\t{{else}}\t\t\t<div class="memoContent fixed-photo-height">\t\t\t\t<img src="${doc.image.url}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t</div>\t\t{{/if}}\t{{else}}\t\t<div class="memoContent {{if doc.sub_type == "photo"}}memo-fixed-photo-height{{/if}}">\t\t\t{{if doc.sub_type == "status"}}\t\t\t\t<p>${doc.title.text}</p>\t\t\t{{/if}}\t\t\t{{if doc.sub_type == "event"}}\t\t\t\t<h3>${doc.title.text}</h3>\t\t\t\t<p>${m.utilities.dateFormat( created_at * 1000, "fullDatePlusTime" ).replace("-", "&middot;")}</p>\t\t\t{{/if}}\t\t\t{{if doc.sub_type == "note"}}\t\t\t\t<h3>${doc.title.text}</h3>\t\t\t\t<p>${jQuery(doc.text.text).text().substr(0, 200) +"..."}</p>\t\t\t{{/if}}\t\t\t{{if doc.sub_type == "link"}}\t\t\t\t{{if doc.title && doc.title.text}}<p style="padding:0 0 10px 0; margin:10px 10px 0 10px; border-bottom:1px solid #ddd;">${doc.title.text}</p>{{/if}}\t\t\t\t<p class="aStyle" style="margin-right:10px; padding-right:0; overflow:hidden;">${doc.link.name}</p>\t\t\t{{/if}}\t\t\t{{if doc.sub_type == "video" && doc.video.thumbnail}}\t\t\t\t<img src="${doc.video.thumbnail}" style="height:150px;" />\t\t\t\t<img src="/img/lane/icon-video.png" class="small-memo-video" alt="video link" />\t\t\t{{/if}}\t\t</div>\t{{/if}}\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
"facebook-pages":'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo facebook-pages" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon"></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t{{if doc.sub_type == "photo"}}\t\t{{if doc.image.sizes && doc.image.sizes.url}}\t\t\t{{if doc.image.sizes.url.width <= 200}}\t\t\t\t<div class="memoContent" style="height:${doc.image.sizes.url.height}px;">\t\t\t\t\t<img src="${doc.image.url}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t\t</div>\t\t\t{{else}}\t\t\t\t<div class="memoContent" style="height:${Math.round((doc.image.sizes.url.height/doc.image.sizes.url.width)*200)}px;">\t\t\t\t\t<img style="width:200px;" src="${doc.image.url}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t\t</div>\t\t\t{{/if}}\t\t{{else}}\t\t\t<div class="memoContent fixed-photo-height">\t\t\t\t<img src="${doc.image.url}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t</div>\t\t{{/if}}\t{{else}}\t\t<div class="memoContent {{if doc.sub_type == "photo"}}memo-fixed-photo-height{{/if}}">\t\t\t{{if doc.sub_type == "status"}}\t\t\t\t<p>${doc.title.text}</p>\t\t\t{{/if}}\t\t\t{{if doc.sub_type == "event"}}\t\t\t\t<h3>${doc.title.text}</h3>\t\t\t\t<p>${m.utilities.dateFormat( created_at * 1000, "fullDatePlusTime" ).replace("-", "&middot;")}</p>\t\t\t{{/if}}\t\t\t{{if doc.sub_type == "note"}}\t\t\t\t<h3>${doc.title.text}</h3>\t\t\t\t<p>${jQuery(doc.text.text).text().substr(0, 200) +"..."}</p>\t\t\t{{/if}}\t\t\t{{if doc.sub_type == "link"}}\t\t\t\t{{if doc.title && doc.title.text}}<p style="padding:0 0 10px 0; margin:10px 10px 0 10px; border-bottom:1px solid #ddd;">${doc.title.text}</p>{{/if}}\t\t\t\t<p class="aStyle" style="margin-right:10px; padding-right:0; overflow:hidden;">${doc.link.name}</p>\t\t\t{{/if}}\t\t\t{{if doc.sub_type == "video" && doc.video.thumbnail}}\t\t\t\t<img src="${doc.video.thumbnail}" style="height:150px;" />\t\t\t\t<img src="/img/lane/icon-video.png" class="small-memo-video" alt="video link" />\t\t\t{{/if}}\t\t</div>\t{{/if}}\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
feed:'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo feed" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon"></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t<div class="memoContent">\t\t{{if doc && doc.category && doc.category.text}}\t\t\t<div class="memoHeaderHTML">\t\t\t\t${doc.category.text}\t\t\t</div>\t\t{{/if}}\t\t{{if doc.title && doc.title.text}}\t\t\t<p>${doc.title.text}</p>\t\t{{else}}\t\t\t{{if doc && doc.text && doc.text.text}}\t\t\t\t<p>{{html $(doc.text.text).text().substr(0, 200) +"..."}}</p>\t\t\t{{/if}}\t\t{{/if}}\t</div>\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
flickr:'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo flickr" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon"></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t{{if doc.sub_type == "image"}}\t\t{{if doc.image.sizes && doc.image.sizes.thumbnail}}\t\t\t{{if doc.image.sizes.thumbnail.width <= 200}}\t\t\t\t<div class="memoContent" style="height:${doc.image.sizes.thumbnail.height}px;">\t\t\t\t\t<img src="${doc.image.thumbnail}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t\t</div>\t\t\t{{else}}\t\t\t\t<div class="memoContent" style="height:${Math.round((doc.image.sizes.thumbnail.height/doc.image.sizes.thumbnail.width)*200)}px;">\t\t\t\t\t<img style="width:200px;" src="${doc.image.thumbnail}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t\t</div>\t\t\t{{/if}}\t\t{{else}}\t\t\t<div class="memoContent fixed-photo-height">\t\t\t\t<img src="${doc.image.thumbnail}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t</div>\t\t{{/if}}\t{{else}}\t\t<div class="memoContent">\t\t\t<img style="height:150px;" src="${doc.video.thumbnail}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t<img src="/img/lane/icon-video.png" class="small-memo-video" alt="video link" />\t\t</div>\t{{/if}}\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
foursquare:'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo foursquare" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon"></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t<div class="memoContent">\t\t{{if doc.title && doc.title.text}}<p>At ${doc.title.text}</p>{{/if}}\t\t<img src="${m.laneLoadMemos.mapquestMapImageURL( doc.geo )}" width="200" height="150"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t</div>\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
instagram:'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo instagram" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon"></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t<div class="memoContent">\t\t<img src="${doc.image.thumbnail}"{{if doc.title && doc.title.text}} title="${doc.title.text}"{{else}} title="Instagram photo"{{/if}} height="150" width="150" />\t</div>\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
lastfm:'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo lastfm" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon"></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t<div class="memoContent">\t\t{{if (doc.track && doc.track.artist && doc.track.artist.thumbnail)}}\t\t\t<div class="lastfmImgMask">\t\t\t\t<img src="${doc.track.artist.thumbnail}" alt="By ${doc.track.artist.name}" />\t\t\t\t<h3>${doc.track.artist.name}</h3>\t\t\t\t<p>${doc.track.name}</p>\t\t\t</div>\t\t{{else}}\t\t\t<div style="margin:10px;">\t\t\t\t<h3>${doc.track.artist.name}</h3>\t\t\t\t<p>${doc.track.name}</p>\t\t\t</div>\t\t{{/if}}\t</div>\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
myspace:'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo myspace" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon"></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t<div class="memoContent">\t\t{{if doc.sub_type == "mood"}}\t\t\t<p>{{if doc.title && doc.title.thumbnail}}<img src="${doc.title.thumbnail}" alt="mood image" style="padding-right:5px; float:left;" />{{/if}}${doc.title.text}</p>\t\t{{/if}}\t\t{{if doc.sub_type == "photo"}}\t\t\t<img class="memo-mainPhoto" src="${doc.image.url}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t{{/if}}\t\t{{if doc.sub_type == "video"}}\t\t\t<img style="height:150px;" src="${doc.video.thumbnail}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t<img src="/img/lane/icon-video.png" class="small-memo-video" alt="video link" />\t\t{{/if}}\t</div>\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
picasa:'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo picasa" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon"></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t{{if doc.image.sizes && doc.image.sizes.thumbnail}}\t\t{{if doc.image.sizes.thumbnail.width <= 200}}\t\t\t<div class="memoContent" style="height:${doc.image.sizes.thumbnail.height}px;">\t\t\t\t<img src="${doc.image.thumbnail}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t</div>\t\t{{else}}\t\t\t<div class="memoContent" style="height:${Math.round((doc.image.sizes.thumbnail.height/doc.image.sizes.thumbnail.width)*200)}px;">\t\t\t\t<img style="width:200px;" src="${doc.image.thumbnail}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t</div>\t\t{{/if}}\t{{else}}\t\t<div class="memoContent fixed-photo-height">\t\t\t<img src="{{if doc.image.thumbnail}}${doc.image.thumbnail}{{else}}${doc.image.url}{{/if}}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t</div>\t{{/if}}\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
soundcloud:'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo soundcloud" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon"></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t<div class="memoContent">\t\t<p>${doc.title.text}</p>\t\t{{if doc.waveform && doc.waveform.url}}<img src="${doc.waveform.url}" class="soundcloud-waveform" width="200" height="31" title="waveform for this track" />{{/if}}\t</div>\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
tripit:'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo tripit" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon"></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t<div class="memoContent">\t\t<p style="text-align:center;">\t\t{{each doc.geo.poi}}\t\t\t${$value.name.substr(-3)}\t\t\t{{if $index < (doc.geo.poi.length - 1)}}<strong class="tripArrow">&rarr;</strong>{{/if}}\t\t{{/each}}\t\t</p>\t\t<img src="${m.laneLoadMemos.mapquestMapImageURL( doc.geo )}" width="200" height="150"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t</div>\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
twitter:'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo twitter" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source{{if doc.author && doc.author.name}} (by ${doc.author.name}){{/if}}"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon" {{if doc.author && doc.author.name}}title="By ${doc.author.name}"{{/if}}></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t{{if doc.image}}\t\t{{if doc.image.sizes && doc.image.sizes.thumbnail}}\t\t\t{{if doc.image.sizes.thumbnail.width <= 200}}\t\t\t\t<div class="memoContent" style="height:${doc.image.sizes.thumbnail.height}px;">\t\t\t\t\t<img src="${doc.image.thumbnail}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t\t</div>\t\t\t{{else}}\t\t\t\t<div class="memoContent" style="height:${Math.round((doc.image.sizes.thumbnail.height/doc.image.sizes.thumbnail.width)*200)}px;">\t\t\t\t\t<img style="width:200px;" src="${doc.image.thumbnail}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t\t</div>\t\t\t{{/if}}\t\t{{else}}\t\t\t<div class="memoContent fixed-photo-height">\t\t\t\t<img src="{{if doc.image.thumbnail}}${doc.image.thumbnail}{{else}}${doc.image.url}{{/if}}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t</div>\t\t{{/if}}\t{{else}}\t\t<div class="memoContent">\t\t\t<p>${doc.title.text}</p>\t\t</div>\t{{/if}}\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
vimeo:'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo vimeo" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon"></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t<div class="memoContent">\t\t{{if doc.video && doc.video.thumbnail}}\t\t\t<img style="height:150px;" src="${doc.video.thumbnail}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t<img src="/img/lane/icon-video.png" class="small-memo-video" alt="video link" />\t\t{{/if}}\t</div>\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
wordpress:'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo wordpress" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon"></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t<div class="memoContent">\t\t{{if doc && doc.category && doc.category.text}}\t\t\t<div class="memoHeaderHTML">\t\t\t\t${doc.category.text}\t\t\t</div>\t\t{{/if}}\t\t{{if doc.title && doc.title.text}}\t\t\t<p>${doc.title.text}</p>\t\t{{else}}\t\t\t{{if doc && doc.text && doc.text.text}}\t\t\t\t<p>{{html $(doc.text.text).text().substr(0, 200) +"..."}}</p>\t\t\t{{/if}}\t\t{{/if}}\t</div>\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>',
youtube:'<div><div id="${m.utilities.cleanMemoId( id )}" class="memo youtube" data-time="${created_at}">\t<div class="memoTitleBar">\t\t{{if (source_url)}}\t\t\t<a href="${source_url}" class="memoServiceIcon" title="Go back to source"></a>\t\t{{else}}\t\t\t<div class="memoServiceIcon"></div>\t\t{{/if}}\t\t{{if (!m.currentUser || user_id != m.currentUser.userID)}}\t\t\t<a href="/users/${user_id}" class="memoAvatar killEvent" title="Go to Dashboard">\t\t\t\t<img src="/users/${user_id}/image.small" height="20" width="20" />\t\t\t</a>\t\t{{/if}}\t</div>\t<div class="memoContent">\t\t{{if doc.video && doc.video.thumbnail}}\t\t\t<img src="${doc.video.thumbnail}"{{if doc.title}} title="${doc.title.text}"{{else}}{{if doc.description}} title="${doc.description.text}"{{/if}}{{/if}} />\t\t\t<img src="/img/lane/icon-video.png" class="small-memo-video" alt="video link" />\t\t{{/if}}\t</div>\t<div class="memoFooterBar">\t\t{{if (m.currentUser && m.currentUser.userID == user_id)}}\t\t\t<ul class="memoOwnerActions">\t\t\t\t<li><div class="memo_icon memo_privacy memo_${privacy}">${privacy}</div></li>\t\t\t</ul>\t\t{{/if}}\t</div></div></div>'}}}}(this,
jQuery,this.undefined);m.laneLoadMemos.initialize();
m.share=function(f,a){return{initialize:function(){a(".shareURL").live(m.clickOrTouchStart,a.proxy(this.shareDialog,this))},shareDialog:function(b){var c=a(b.target),d=window.location.protocol+"//"+window.location.hostname+c.data("share-link").replace(" ","%2520");$dialog=a.tmpl(this.templates.shareLaneDialog,{url:encodeURIComponent(d),shareText:encodeURIComponent(c.data("share-text")),shareDialogText:c.data("share-dialog-text")});$dialog.find(".shareFacebook").click(function(b){window.open(a(this).attr("href"),"Share on Facebook",
"width=600,height=400");b.preventDefault()}).end().find(".shareTwitter").click(function(b){window.open(a(this).attr("href"),"Share on Twitter","width=600,height=400");b.preventDefault()}).end().find("#shortenURL").click(function(){a(this).select()}).end().lightbox_me({centered:true});a.ajax({url:"/shorten?path="+encodeURIComponent("/"+c.data("share-link")),success:function(b){a("#shareURL").css("visibility","visible").find("#shortenURL").val(b.url).focus().select()}});b.preventDefault()},templates:{shareLaneDialog:'<div id="shareLaneDialog" class="memolaneDialog" style="width:400px">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">${shareDialogText}</div>\t\t<div class="close closeMemolaneDialog">close</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<ul class="shareMemoOptions">\t\t\t<li><a href="http://www.facebook.com/share.php?u=${url}&amp;t=${shareText}" class="shareFacebook">Facebook</a></li>\t\t\t<li><a href="http://twitter.com/share?via=memolane&amp;text=${shareText}&amp;url=${url}" class="shareTwitter">Twitter</a></li>\t\t\t<li id="shareURL">\t\t\t\t<label>Link: <input id="shortenURL" type="text"></label>\t\t\t</li>\t\t</ul>\t</div></div>'}}}(this,
jQuery,this.undefined);m.share.initialize();m.currentUser?$(".user-is-logged-in").show():$(".user-is-not-logged-in").show();$.fn.lightbox_me.defaults.destroyOnClose=true;$.fn.lightbox_me.defaults.centered=true;m.utilities.browser.init();var currentBrowser=m.utilities.browser;(currentBrowser.browser==="Firefox"&&parseInt($.browser.version,10)<6||currentBrowser.browser==="Opera"&&parseInt($.browser.version,10)<11||currentBrowser.browser==="Explorer"&&parseInt($.browser.version,10)<9)&&$('<div class="notifications badnews-notice"><div class="notice-text">请考虑升级您的浏览器，我们建议使用Explorer 9, Opera 11+, Chrome 12+, Firefox 6+, and Safari 5+浏览TimePaw，暂不支持手机客户端！<a href="#" class="close-notice">X</a></div></div>').notify({expires:false});
(m.deviceIsIphone||Modernizr.touch&&!m.deviceIsIpad&&!m.deviceIsAndroid||m.deviceIsAndroid&&!navigator.userAgent.toLowerCase().match(/android 3/i))&&$('<div class="notifications badnews-notice"><div class="notice-text">Please consider using an ipad or android (3+) tablet device. Or a modern browser on a desktop or laptop computer. We currently don\'t build memolane for a mobile phone experience. <a href="#" class="close-notice">X</a></div></div>').notify({expires:false});$.ajaxSetup({data:{_csrf:m.csrf}});
$.ajaxPrefilter(function(f){f.type.toLowerCase()==="delete"&&(f.data+="&_method=DELETE")});
