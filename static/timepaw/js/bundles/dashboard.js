m.utilities={breakURLCache:function(e){return e+"?breakCache="+(new Date).getTime()},browser:{init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(e){for(var b=0;b<e.length;b++){var a=e[b].string,c=e[b].prop;this.versionSearchString=e[b].versionSearch||e[b].identity;if(a){if(a.indexOf(e[b].subString)!=
-1)return e[b].identity}else if(c)return e[b].identity}},searchVersion:function(e){var b=e.indexOf(this.versionSearchString);return b==-1?void 0:parseFloat(e.substring(b+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera"},
{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,
subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]},capitalizeString:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},wait:function(e){return $.Deferred(function(b){setTimeout(b.resolve,e)})},dateFormatRelative:function(e){var e=
new Date(e*1E3),b=new Date,a="",a=(b.getTime()-e.getTime())/6E4,c=b.getHours()*60+b.getMinutes();return a=e.getYear()<b.getYear()?this.dateFormat(e,"mmm d, yyyy",false):a-c>1440?this.dateFormat(e,"mmm d",false):a-c>0?"yesterday":a<60?Math.floor(a)+" min ago":Math.floor(a/60)+" hrs ago"},cleanMemoId:function(e){return e.replace(/[:=-_@\.\/]/g,"")},dateFormat:function(){var e=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,b=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,
a=/[^-+\dA-Z]/g,c=function(a,b){a=String(a);for(b=b||2;a.length<b;)a="0"+a;return a};return function(d,f,q){var g,o,n;n={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",shortDateWithZero:"mm/dd/yyyy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",fullDatePlusTime:"dddd, mmmm d - h:MM tt",fullDateAndTime:"m/d/yy h:MM:ss TT Z",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",
isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};g="Sun,Mon,Tue,Wed,Thu,Fri,Sat,Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday".split(",");o="Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec,January,February,March,April,May,June,July,August,September,October,November,December".split(",");arguments.length==1&&Object.prototype.toString.call(d)=="[object String]"&&!/\d/.test(d)&&(f=d,d=void 0);d=d?new Date(d):new Date;if(isNaN(d))throw SyntaxError("invalid date");f=String(n[f]||f||n["default"]);
f.slice(0,4)=="UTC:"&&(f=f.slice(4),q=true);var l=q?"getUTC":"get";n=d[l+"Date"]();var h=d[l+"Day"](),p=d[l+"Month"](),s=d[l+"FullYear"](),r=d[l+"Hours"](),u=d[l+"Minutes"](),v=d[l+"Seconds"](),l=d[l+"Milliseconds"](),t=q?0:d.getTimezoneOffset(),w={d:n,dd:c(n),ddd:g[h],dddd:g[h+7],m:p+1,mm:c(p+1),mmm:o[p],mmmm:o[p+12],yy:String(s).slice(2),yyyy:s,h:r%12||12,hh:c(r%12||12),H:r,HH:c(r),M:u,MM:c(u),s:v,ss:c(v),l:c(l,3),L:c(l>99?Math.round(l/10):l),t:r<12?"a":"p",tt:r<12?"am":"pm",T:r<12?"A":"P",TT:r<
12?"AM":"PM",Z:q?"UTC":(String(d).match(b)||[""]).pop().replace(a,""),o:(t>0?"-":"+")+c(Math.floor(Math.abs(t)/60)*100+Math.abs(t)%60,4),S:["th","st","nd","rd"][n%10>3?0:(n%100-n%10!=10)*n%10]};return f.replace(e,function(a){return a in w?w[a]:a.slice(1,a.length-1)})}}(),convertURLstringsToAnchors:function(e){return e.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&~\?\/.=]+/g,function(b){return b.link(b)})},urlHash:{set:function(e){var e=$.toQueryParams(e),b=$.toQueryParams(location.hash),
a;for(a in e)b[a]=e[a];return $.toQueryString(b)},remove:function(e){var e=$.toQueryParams(e),b=$.toQueryParams(location.hash),a={},c;for(c in b)e[c]==void 0&&(a[c]=b[c]);return $.toQueryString(a)},get:function(e){return typeof e=="undefined"?$.toQueryParams(location.hash):$.toQueryParams(location.hash)[e]},go:function(e){location.hash=e.substr(0,1)=="#"?e:"#"+e;return false}}};
m.globalTemplates={dialogs:{removeLane:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Remove Lane</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">cancel</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<p><strong>Are you sure you want to remove <strong>${title}</strong> from Memolane?</strong></p>\t\t<p>All settings will be lost, and any work you\'ve put into curating this lane will be permanently gone!</p>\t\t<p><a href="#" class="btn-red float-left removeConfirm close">Yes, REMOVE the lane!</a> <a href="#" class="secondaryAction float-left close">No, I don\'t want that</a></p>\t</div></div>',removeLaneContributor:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Stop Contributing?</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">cancel</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<p><strong>Are you sure you wish to stop contributing to this lane: ${lane_title}</strong></p>\t\t<p><a href="#" class="btn-red float-left removeConfirm close">Remove me as a contributor from this lane</a> <a href="#" class="secondaryAction float-left close">No, I don\'t want that</a></p>\t</div></div>',
addFriend:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Friend Request Sent</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">close</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<h2 class="header typeJ">Cross your fingers!</h2>\t\t<p>You just sent a friend request to <strong>${first_name} ${last_name}</strong>.</p>\t\t<p><a href="#" class="btn-green float-left close">OK</a></p>\t</div></div>',acceptFriendRequest:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Accepted Friend Request</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">close</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<h2 class="header typeJ">We\'re friends!</h2>\t\t<p>You just accepted <strong>${first_name} ${last_name}\'s</strong> friend request!</p>\t\t<p>You can now see each other\'s "Friends Only" memos.</p>\t\t<p><a href="#" class="btn-green float-left close">OK</a></p>\t</div></div>',
rejectFriendRequest:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Rejected Friend Request</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">close</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<h2 class="header typeJ">It\'s not you, it\'s me</h2>\t\t<p>You just rejected <strong>${first_name} ${last_name}\'s</strong> friend request.</p>\t\t<p>At this point, you can only see each other\'s public memos.</p>\t</div></div>',
cancelFriendRequest:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Cancelled Friend Request</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">close</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<h2 class="header typeJ">It\'s not you, it\'s me</h2>\t\t<p>You just cancelled your request for <strong>${first_name} ${last_name}\'s</strong> friendship.</p>\t\t<p>At this point, you can only see each other\'s public memos.</p>\t</div></div>',
removeFriend:'<div id="" class="memolaneDialog">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">Remove Friend?</div>\t\t<div class="close closeMemolaneDialog cancelAddingBtn">cancel</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<p><strong>Are you sure you want to cancel your Memolane friendship with ${first_name} ${last_name}</strong>?</p>\t\t<p>You and ${first_name} ${last_name} will lose the ability to see each other\'s "Friends Only" memos and contribute to each other\'s lanes.</p>\t\t<p><a href="#" class="btn-red float-left removeConfirm close">Yes, REMOVE the friend!</a> <a href="#" class="secondaryAction float-left close">No, I don\'t want that</a></p>\t</div></div>'}};
m.deviceIsIpad=navigator.userAgent.match(/iPad/i)!=null;m.deviceIsIphone=navigator.userAgent.match(/iPhone/i)!=null;m.deviceIsAndroid=navigator.userAgent.toLowerCase().indexOf("android")>-1;m.isIE9=$.browser.version==="9.0"?true:false;m.isIE8=$.browser.version==="8.0"?true:false;m.clickOrTouchStart=Modernizr.touch?"touchstart":"click";m.clickOrTouchEnd=Modernizr.touch?"touchend":"click";m.mouseEnterOrTouchStart=Modernizr.touch?"touchstart":"mouseenter";
m.mouseLeaveOrTouchEnd=Modernizr.touch?"touchend":"mouseleave";m.mouseDownOrTouchStart=Modernizr.touch?"touchstart":"mousedown";m.mouseMoveOrTouchMove=Modernizr.touch?"touchmove":"mousemove";m.mouseUpOrTouchEnd=Modernizr.touch?"touchend":"mouseup";m.mouseOutOrTouchEnd=Modernizr.touch?"touchend":"mouseout";m.mouseOverOrTouchStart=Modernizr.touch?"touchstart":"mouseover";
m.topBar=function(e,b){return{initialize:function(){b(e).bind("resize",function(){m.topBar.runLayout()});this.runLayout()},runLayout:function(){var a=b("body"),c=b("#header"),d=b("#tb-search input");a.width()<1E3&&(c.removeClass("more1024").addClass("less1024"),d.attr("value","Search"));a.width()>=1E3&&(c.removeClass("less1024").addClass("more1024"),m.currentLane?d.attr("value","找回过去的时光"):d.attr("value","Search lanes & users"))}}}(this,jQuery,this.undefined);m.topBar.initialize();
m.topBarDropDowns=function(e,b){return{$tbDropDowns:b(".tb-dropdown"),$dropDowns:b(".dd-container"),$dropDownsListContent:b(".dd-list-content"),jScrollGutter:5,loaderClass:"small-loader-on-grey",ddListHeight:350,ddWaitHeight:100,friendsContext:"main",friendRequests:0,hashOnPageLoad:window.location.hash.substring(1).toLowerCase(),initialize:function(){var a=this;this.$tbDropDowns.bind(m.clickOrTouchStart,b.proxy(this.initDD,this));this.$dropDownsListContent.jScrollPane({verticalGutter:a.jScrollGutter});
b(document).bind(m.clickOrTouchStart,b.proxy(this.closeAllDropdownsFromClickOff,this));this.$dropDownsListContent.delegate(".dd-friends-remove",m.clickOrTouchStart,function(){a.removeFriendDialog(b(this));return false}).delegate(".dd-friends-pending-remove",m.clickOrTouchStart,function(c){a.removeFriendPendingRequest(c,b(this));return false}).delegate(".dd-friends-friend-yes",m.clickOrTouchStart,function(c){a.acceptFriendRequest(c,b(this));return false}).delegate(".dd-friends-friend-no",m.clickOrTouchStart,
function(c){a.rejectFriendRequest(c,b(this));return false}).delegate(".dd-lanes-remove",m.clickOrTouchStart,function(){a.removeLaneDialog(b(this));return false}).delegate(".dd-lanes-fav-remove",m.clickOrTouchStart,function(){a.removeLaneFav(b(this));return false}).delegate(".dd-lanes-edit",m.clickOrTouchStart,function(){a.editLane(b(this))}).delegate(".dd-lanes-remove-contrib",m.clickOrTouchStart,function(){a.removeLaneContributorDialog(b(this));return false});b(".dd-friends-types").delegate("a",
m.clickOrTouchStart,function(b){a.toggleFriendsTypes(b);return false});this.getNewNewsNumber();this.getIncomingFriendsRequestsNumber();if(this.hashOnPageLoad){var c=m.utilities.urlHash.get("topBar");c&&setTimeout(function(){switch(c){case "getFriends":b("#dd-friends-button").trigger("click");break;case "getNews":b("#dd-news-button").trigger("click");break;case "getLanes":b("#dd-lanes-button").trigger("click")}},1500)}b("#dd-lanes .smallButtonBar li a").bind(m.clickOrTouchStart,function(){var c=b(this);
if(c.hasClass("smallButtonActive"))return false;var f=b(this).parent().attr("id");c.closest("ul").find("a").removeClass("smallButtonActive").end().end().addClass("smallButtonActive");b("#dd-fav-lanes,#dd-your-lanes").hide();b("#"+f.slice(0,f.indexOf("-btn"))).addClass("visibility-hidden").show().height(100);c=b("#"+f.slice(0,f.indexOf("-btn"))+" ul").height();c=c>400?400:c;b("#"+f.slice(0,f.indexOf("-btn"))).show().css("height",c+"px").removeClass(a.loaderClass).jScrollPane({verticalGutter:a.jScrollGutter}).removeClass("visibility-hidden").find(".jspVerticalBar").removeClass("visibility-hidden");
return false})},initDD:function(a){var a=b(a.currentTarget),c=a.attr("data-ddid"),d=b("#"+c),f=b(".dd-container");if(d.css("visibility")==="visible")return this.closeDropdown(a,d),false;else{switch(c){case "dd-friends":this.getFriends();break;case "dd-lanes":this.getLanes();break;case "dd-news":this.getNews()}f.filter(function(){return b(this).css("visibility")=="visible"}).length&&this.closeAllDropdowns();this.positionDropdown(a,d)}},getNews:function(){var a=this,c=b("#dd-news");c.find(".dd-list-content").addClass(a.loaderClass).css("height",
a.ddWaitHeight).find("ul").empty().end().find(".jspVerticalBar").addClass("visibility-hidden");a.getNewNewsNumber();b.ajax({url:"/feed",cache:false,success:function(d){for(var f=0,e=d.feed.length,g={},o=g="",n="";f<e;)g=d.feed[f],g.date_str=m.utilities.dateFormatRelative(g.created_at),n=a.templates.news[g.type],g=b("<div />").append(b.tmpl(n,g)).html(),o=g+o,f++;e===0&&(o='<li class="no-dd-list-item">No news yet</li>');c.find(".dd-list-content ul").html(o);d=c.find(".dd-list-content ul").height();
d=d>a.ddListHeight?a.ddListHeight:d;c.find(".dd-list-content").removeClass(a.loaderClass).css("height",d+"px").jScrollPane({verticalGutter:a.jScrollGutter}).find(".jspVerticalBar").removeClass("visibility-hidden")}})},getNewNewsNumber:function(){var a=4;b.ajax({url:"/feed/volume",success:function(c){a=parseInt(c.volume);a>0?b("#tb-news-count").css("display","inline").children("span").text(a):b("#tb-news-count").css("display","none")}})},hideNewNewsIndicator:function(){var a=b("#tb-news-count");a.css("display")!=
"none"&&a.fadeOut()},getFriends:function(){var a=this;b("#dd-friends");var c=b(".dd-friends-main-pane"),d=b(".dd-friends-pending-pane");b(".dd-friends-types .smallButtonBar a").removeClass("smallButtonActive");b("#dd-friends-main").addClass("smallButtonActive");d.show().find("ul").empty();c.show();c.css("height",a.ddWaitHeight).addClass(a.loaderClass).find("ul").empty().end().find(".jspVerticalBar").addClass("visibility-hidden");b.ajax({url:"/friends/all",cache:false,success:function(f){var e=0,g=
{},g="",o={},n="",l="",h="",l=f.length,h=h=0,p={pending:0,requested:0,accepted:0};for(content={pending:"",accepted:"",requested:""};e<l;)g=f[e],h=g.status,p[h]++,o=a.templates.friends[h],g=b("<div />").append(b.tmpl(o,g)).html(),content[h]+=g,e++;p.requested||p.accepted?(n+=content.requested,n+=content.accepted):n='<li class="no-dd-list-item">You got peeps, everyone does. Why not make a friend. You can use search to find memolane users to befriend. Or visit a users dashboard and request some good old fashion friendship.</li>';
l=p.pending?content.pending:'<li class="no-dd-list-item">At this time you haven\'t requested any friendships. Give it a crack. This internet thing is a whole lot funnier with friends.</li>';c.find("ul").html(n);h=c.find("ul").height();h=h>a.ddListHeight?a.ddListHeight:h;c.css("height",h+"px").removeClass(a.loaderClass).jScrollPane({verticalGutter:a.jScrollGutter}).find(".jspVerticalBar").removeClass("visibility-hidden");d.find("ul").html(l);h=d.find("ul").height();h=h>a.ddListHeight?a.ddListHeight:
h;d.hide().css("height",h+"px").removeClass(a.loaderClass).jScrollPane({verticalGutter:a.jScrollGutter}).find(".jspVerticalBar").removeClass("visibility-hidden");a.setNewFriendsIndicator(p.requested)}})},getIncomingFriendsRequestsNumber:function(){var a=this;b.ajax({url:"/friends/requested",cache:false,success:function(b){a.setNewFriendsIndicator(b.length)}})},setNewFriendsIndicator:function(a){this.friendRequests=a;a>0?b("#tb-friends-count").css("display","inline").children("span").text(a):b("#tb-friends-count").css("display",
"none")},toggleFriendsTypes:function(a){var c=b(a.target),d=c.attr("id").replace("dd-","");this.friendsContext=d;b("#dd-friends .dd-list-content").hide();b(".dd-"+d+"-pane").show();b(".dd-friends-types .smallButtonBar a").removeClass("smallButtonActive");c.addClass("smallButtonActive");a.preventDefault()},removeFriendDialog:function(a){var c=this,d={first_name:a.attr("data-first_name"),last_name:a.attr("data-last_name"),username:a.attr("data-username")},a=b.tmpl(m.globalTemplates.dialogs.removeFriend,
d);a.find(".removeConfirm").bind(m.clickOrTouchEnd,{something:"other"},function(a){m.dashboard?m.dashboard.removeFriend(d.username):c.removeFriend(d.username);a.preventDefault()});a.lightbox_me({centered:true})},removeFriend:function(a){var c=this;b.ajax({type:"delete",url:"/friends/"+a,success:function(){c.getFriends()}})},rejectFriendRequest:function(a,c){var d={first_name:c.attr("data-first_name"),last_name:c.attr("data-last_name"),username:c.attr("data-username")};$dialog=b.tmpl(m.globalTemplates.dialogs.rejectFriendRequest,
d);$dialog.lightbox_me({centered:true});m.dashboard?m.dashboard.removeFriend(d.username):this.removeFriend(d.username);this.getFriends();this.setNewFriendsIndicator(this.friendRequests-1)},acceptFriendRequest:function(a,c){var d={username:c.attr("data-username"),first_name:c.attr("data-first_name"),last_name:c.attr("data-last_name")};m.dashboard?m.dashboard.acceptFriend(d.username):b.ajax({type:"post",cache:false,url:"/friends/"+d.username+"/accept",success:function(){$dialog=b.tmpl(m.globalTemplates.dialogs.acceptFriendRequest,
d);$dialog.lightbox_me({centered:true})}});this.getFriends();this.setNewFriendsIndicator(this.friendRequests-1)},removeFriendPendingRequest:function(a,b){var d=b.data("username");m.dashboard?m.dashboard.removeFriend(d):this.removeFriend(d);this.getFriends()},getLanes:function(){var a=this,c=b("#dd-lanes"),d=b("#dd-your-lanes");b("#dd-your-lanes-btn a").addClass("smallButtonActive");b("#dd-fav-lanes-btn a").removeClass("smallButtonActive");b("#dd-fav-lanes").hide().find("ul").empty();d.show().css("height",
a.ddWaitHeight).addClass(a.loaderClass).find("ul").empty().end().find(".jspVerticalBar").addClass("visibility-hidden");b.ajax({url:"/"+m.currentUser.username+"/lanes",cache:false,success:function(f){f.length?b.tmpl(a.templates.lanes.main,f).appendTo(c.find("#dd-your-lanes ul")):b('<li class="no-dd-list-item">Start building a lane by clicking on the "New Lane" button above.</li>').appendTo(c.find("#dd-your-lanes ul"));f=d.find("ul").height();f=f>400?400:f;c.find("#dd-your-lanes").css("height",f+"px").removeClass(a.loaderClass).jScrollPane({verticalGutter:a.jScrollGutter}).find(".jspVerticalBar").removeClass("visibility-hidden")}});
b.ajax({url:"/"+m.currentUser.username+"/favorite_lanes",cache:false,data:{username:m.currentUser.username},success:function(d){d.length?b.tmpl(a.templates.lanes.fav,d).appendTo(c.find("#dd-fav-lanes ul")):b('<li class="no-dd-list-item">Quickly and easily find your way back to your favorite lanes by clicking on the heart button to add them to this list.</li>').appendTo(c.find("#dd-fav-lanes ul"))}})},removeLaneDialog:function(a){var c=this,d=a.attr("data-lane_title"),f=a.attr("data-lane_id"),d=b.tmpl(m.globalTemplates.dialogs.removeLane,
{title:d});d.find(".removeConfirm").bind(m.clickOrTouchEnd,function(d){a.closest("li").remove();var e=b("#dd-your-lanes").find("ul").height(),e=e>400?400:e;b("#dd-your-lanes").css("height",e+"px").removeClass(c.loaderClass).jScrollPane({verticalGutter:c.jScrollGutter});m.dashUser?m.dashboard.removeLane(f):c.removeLane(f);d.preventDefault()});d.lightbox_me({centered:true})},removeLaneFav:function(a){var c=a.attr("data-lane_id");a.closest("li").remove();a=b("#dd-fav-lanes").find("ul").height();a=a>
400?400:a;b("#dd-fav-lanes").css("height",a+"px").removeClass(this.loaderClass).jScrollPane({verticalGutter:this.jScrollGutter});m.dashUser?b(".dashFaves #"+c).find(".remove-fav").trigger(m.clickOrTouchEnd):m.currentLane&&m.currentLane.id===c?b("#favorite-un-fav").trigger(m.clickOrTouchEnd):b.ajax({url:"/lanes/favorite",type:"DELETE",data:{lane_id:c}})},removeLaneContributorDialog:function(a){var c=this,d=a.attr("data-lane_title"),f=a.attr("data-lane_id"),e=a.attr("data-owner"),a="",d={lane_title:d},
a=m.globalTemplates.dialogs.removeLaneContributor,d=b.tmpl(a,d);d.find(".removeConfirm").bind(m.clickOrTouchEnd,function(a){m.dashboard?m.dashboard.removeLaneContributor(f):c.removeLaneContributor(f,e);a.preventDefault()});d.lightbox_me({centered:true})},editLane:function(a){a=a.data("id");if(m.currentLane&&m.currentLane.id==a)return window.location="/"+m.currentUser.username+"/"+m.currentLane.title+"?e=1#drawer=edit",false},removeLane:function(a){var c=this;b.ajax({type:"delete",url:"/lanes/"+a,
success:function(){if(m.currentLane&&m.currentLane.id==a)return window.location="/"+m.currentUser.username,false;else c.getLanes()}})},removeLaneContributor:function(a,c){var d=this;b.ajax({type:"delete",url:"/lanes/contributor",data:{lane_id:a,username:m.currentUser.username},success:function(){if(m.currentLane&&m.currentLane.id==a)return window.location="/"+c+"/"+m.currentLane.title,false;else d.getLanes()}})},openDropdown:function(a,b){a.addClass("tb-dropdown-open");m.search&&m.search.closeSearchDD();
b.css("visibility","visible")},closeDropdown:function(a,b){a.data("ddid")=="dd-news"&&this.hideNewNewsIndicator();a.removeClass("tb-dropdown-open");b.css("visibility","hidden")},closeAllDropdownsFromClickOff:function(a){b(a.target).closest(".dd-container,.tb-dropdown, .memolaneDialog").length||this.closeAllDropdowns()},closeAllDropdowns:function(){b(".dd-container").css("visibility","hidden");this.$tbDropDowns.removeClass("tb-dropdown-open")},positionDropdown:function(a,c){var a=a||b(".tb-dropdown-open"),
c=c||b(".dd-container").filter(function(){return b(this).css("visibility")=="visible"}),d=a.offset().left,f=a.offset().top+45,e=b(window).width();d+c.width()>e&&(d-=d+c.width()-e);c.css({top:f+"px",left:d+"px"});c.css("visibility")==="hidden"&&this.openDropdown(a,c);return false},templates:{news:{friendship_request:"",welcome_shout:'<li class="clearfix {{if is_new==true}}new-news{{/if}}"><div class="dd-news-item"><img src="/img/dropdowns/news-welcome.png">Welcome to Memolane! Let your <a class="shareURL" href="#" data-share-link="/'+
(m.currentUser?m.currentUser.username:"")+'" data-share-text="Check out my new Memolane profile" data-share-dialog-text="Share profile on"><span class="icon"></span>Twitter and Facebook</a> friends know so you can share your memories.</div><div class="dd-news-item-date">${date_str}</div></li>',welcome_invite:'<li class="clearfix {{if is_new==true}}new-news{{/if}}"><div class="dd-news-item"><img src="/img/dropdowns/news-tell-friends.png">Tell a friend about Memolane!</div><div class="dd-news-item-date">${date_str}</div></li>',
new_user_invited_by:'<li class="clearfix {{if is_new==true}}new-news{{/if}}"><div class="dd-news-item"><a href="/${content.other.username}">\t<img src="/${content.other.username}/image"></a><a href="**SEND_INVITOR_FRIEND_REQUEST**">Click here</a> to send them a friend request</div><div class="dd-news-item-date">${date_str}</div></li>',friendship:'<li class="clearfix {{if is_new==true}}new-news{{/if}}"><div class="dd-news-item"><a href="/${content.friend.username}">\t${content.friend.first_name} ${content.friend.last_name}</a> and <a href="/${content.other.username}">\t${content.other.first_name} ${content.other.last_name}</a> are now friends</div><div class="dd-news-item-date">${date_str}</div></li>',
friendship_request_accepted:'<li class="clearfix {{if is_new==true}}new-news{{/if}}"><div class="dd-news-item"><a href="/${content.friend.username}">\t<img src="/${content.friend.username}/image"></a><a href="/${content.friend.username}">\t${content.friend.first_name} ${content.friend.last_name}</a> is now your friend</div><div class="dd-news-item-date">${date_str}</div></li>',lane_new_contributor:'<li class="clearfix {{if is_new==true}}new-news{{/if}}"><div class="dd-news-item"><a href="/lanes/${content.lane.id}" title="view lane"><img src="/lanes/${content.lane.id}/avatar.small" alt="topBarAvatar"/></a><a href="/${content.new_contributor.username}">${content.new_contributor.first_name} ${content.new_contributor.last_name}</a> has been added to the lane <span class="lane-name-DD"><a href="/lanes/${content.lane.id}" title="view lane">${content.lane.title}</a></span></div><div class="dd-news-item-date">${date_str}</div></li>',
added_to_lane:'<li class="clearfix {{if is_new==true}}new-news{{/if}}"><div class="dd-news-item"><a href="/${content.added_by.username}">\t<img src="/${content.added_by.username}/image"></a><a href="/${content.added_by.username}">\t${content.added_by.first_name} ${content.added_by.last_name}</a> has added you as a contributor to the lane <a href="/lanes/${content.lane.id}">${content.lane.title}</a></div><div class="dd-news-item-date">${date_str}</div></li>'},lanes:{main:'<li class="clearfix">\t<a href="/${owner.username}/${title}" title="view lane">\t\t<div class="dd-list-item">\t\t\t<img src="/lanes/${id}/avatar.small" alt="topBarAvatar"/>\t\t\t<span class="lane-name-DD">${title}</span>\t\t\t{{if role=="contributor"}}\t\t\t<span class="lane-type-DD">(contributor)</span></div>\t<a href="#" class="dd-lanes-remove-contrib" data-lane_id="${id}" data-owner="${owner.username}" data-lane_title="${title}" title="remove my content from this lane">X</a>\t{{else}}\t</div>\t<a href="#" class="dd-lanes-remove" data-lane_id="${id}" data-lane_title="${title}"  title="delete lane" >X</a>\t<a href="/${owner.username}/${title}#drawer=edit" class="dd-lanes-edit" title="edit lane" data-id="${id}">X</a>\t{{/if}}\t</a></li>',
fav:'<li class="clearfix"><a href="/${owner.username}/${title}" title="view lane"><div class="dd-list-item"><img src="/lanes/${id}/avatar.small" alt="topBarAvatar"/><span class="lane-name-DD">${title}</span><span class="lane-type-DD">by ${owner.first_name} ${owner.last_name} (${owner.username})</span></div>{{if true}}<a href="#" class="dd-lanes-fav-remove" data-lane_id="${id}" data-lane_title="${title}"  title="Remove from favorites" >X</a>{{/if}}</a></li>'},friends:{accepted:'<li class="clearfix"><a href="/${other_username}" title="view dashboard"><div class="dd-list-item"><img src="/${other_username}/image" alt="topBarAvatar"/><span class="name-friends-DD">${other_first_name} ${other_last_name}</span> <span class="user-name-friends-DD">(${other_username})</span></div><a href="#" class="dd-friends-remove" title="remove friend" data-username="${other_username}" data-first_name="${other_first_name}"  data-last_name="${other_last_name}">X</a></div></a></li>',
requested:'<li class="clearfix friend-request-list">\t<a href="/${other_username}" title="view dashboard">\t\t<div class="dd-list-item">\t\t\t<img src="/${other_username}/image" alt="topBarAvatar"/>\t\t\t<span class="name-friends-DD">${other_first_name} ${other_last_name}</span> \t\t\t<span class="user-name-friends-DD">(${other_username})</span>\t\t</div>\t\t<a href="#" data-username="${other_username}" data-first_name="${other_first_name}" \t\t\tdata-last_name="${other_last_name}" class="dd-friends-friend-no" \t\t\ttitle="Deny Friendship Request">Deny</a> \t<a href="#" data-username="${other_username}" data-first_name="${other_first_name}" data-last_name="${other_last_name}" class="dd-friends-friend-yes" title="Confirm Friendship Request">Confirm</a></div></a></li>',
pending:'<li class="clearfix"><a href="/${other_username}" title="view dashboard"><div class="dd-list-item"><img src="/${other_username}/image" alt="topBarAvatar"/><span class="name-friends-DD">${other_first_name} ${other_last_name}</span> <span class="user-name-friends-DD">(${other_username})</span></div><a href="#" data-username="${other_username}" class="dd-friends-pending-remove" title="remove friend request" data-username="${other_username}" data-first_name="${other_first_name}"  data-last_name="${other_last_name}">X</a></div></a></li>'}}}}(this,
jQuery,this.undefined);m.currentUser!=null&&m.topBarDropDowns.initialize();
m.share=function(e,b){return{initialize:function(){b(".shareURL").live(m.clickOrTouchStart,b.proxy(this.shareDialog,this))},shareDialog:function(a){var c=b(a.target),d=window.location.protocol+"//"+window.location.hostname+c.data("share-link").replace(" ","%2520");$dialog=b.tmpl(this.templates.shareLaneDialog,{url:encodeURIComponent(d),shareText:encodeURIComponent(c.data("share-text")),shareDialogText:c.data("share-dialog-text")});$dialog.find(".shareFacebook").click(function(a){window.open(b(this).attr("href"),
"Share on Facebook","width=600,height=400");a.preventDefault()}).end().find(".shareTwitter").click(function(a){window.open(b(this).attr("href"),"Share on Twitter","width=600,height=400");a.preventDefault()}).end().find("#shortenURL").click(function(){b(this).select()}).end().lightbox_me({centered:true});b.ajax({url:"/shorten?path="+encodeURIComponent("/"+c.data("share-link")),success:function(a){b("#shareURL").css("visibility","visible").find("#shortenURL").val(a.url).focus().select()}});a.preventDefault()},
templates:{shareLaneDialog:'<div id="shareLaneDialog" class="memolaneDialog" style="width:400px">\t<div class="dialogTopBar">\t\t<div class="dialogTitle">${shareDialogText}</div>\t\t<div class="close closeMemolaneDialog">close</div>\t\t<div class="clearFloatNoHeight"></div>\t</div>\t<div class="dialogContent">\t\t<ul class="shareMemoOptions">\t\t\t<li><a href="http://www.facebook.com/share.php?u=${url}&amp;t=${shareText}" class="shareFacebook">Facebook</a></li>\t\t\t<li><a href="http://twitter.com/share?via=memolane&amp;text=${shareText}&amp;url=${url}" class="shareTwitter">Twitter</a></li>\t\t\t<li id="shareURL">\t\t\t\t<label>Link: <input id="shortenURL" type="text"></label>\t\t\t</li>\t\t</ul>\t</div></div>'}}}(this,
jQuery,this.undefined);m.share.initialize();
m.search=function(e,b,a){return{$searchInput:b("#search-input"),$closeSearchBtn:b("#close-search-btn"),$searchDD:b("#dd-search"),$tbSearch:b("#tb-search"),$searchTypesA:b("#search-types a"),$searchResults:b(".search-results"),searchDDOpen:false,searchContext:m.currentLane?"search-memos":"search-lanes",loaderClass:"small-loader-on-grey",jScrollGutter:5,maxDDContentHeight:320,searchLaneScope:"world",searchTimeout:a,initialize:function(){m.currentLane||(b("#search-memos").hide(),b("#search-lanes").show(),
b("#search-lanes-filter-friends").show());var a=this;this.$searchInput.focus(b.proxy(this.searchInputFocus,this)).blur(b.proxy(this.searchInputBlur,this)).keyup(b.proxy(this.searchInputkeyup,this));this.$closeSearchBtn.bind(m.clickOrTouchStart,b.proxy(function(){this.closeSearchDD()},this));b(document).bind(m.clickOrTouchStart,b.proxy(this.closeSearchDDFromClickOff,this));this.$searchTypesA.bind(m.clickOrTouchStart,b.proxy(function(a){this.toggleSearchContext(a)},this));this.$searchResults.delegate(".request-friendship",
m.clickOrTouchStart,function(){a.addFriendDialog(b(this));return false});b("#search-lanes-filter-friends input").bind(m.clickOrTouchStart,function(){a.setLaneSearchFilter(b(this))})},searchInputFocus:function(a){var d=b(a.target),e=d.val();d.val(e===a.target.defaultValue?"":e).addClass("search-focused").data("hasFocus",true);this.$closeSearchBtn.show()},searchInputBlur:function(a){var d=b(a.target);this.$searchDD.css("visibility")!=="visible"&&(d.val(a.target.defaultValue).removeClass("search-focused").data("hasFocus",
false),this.$closeSearchBtn.hide(),this.$tbSearch.css("background-color","transparent"))},closeSearchDD:function(){this.$searchDD.css("visibility","hidden");this.$searchInput.trigger("blur");this.searchDDOpen=false},closeSearchDDFromClickOff:function(a){b(a.target).closest("#dd-search,#tb-search,.memolaneDialog").length||this.closeSearchDD()},searchInputkeyup:function(a){b(a.target);a=this.$searchInput.val();if(a.length!=0&&a.length>=3||this.searchDDOpen)this.searchDDOpen===false&&(this.$tbSearch.css("background-color",
"#f1f1f1"),this.openSearchDD()),this.doSearchDebounce(this.searchContext),foo=false},openSearchDD:function(){this.searchDDOpen=true;m.topBarDropDowns.closeAllDropdowns();this.$searchDD.css("visibility","visible")},toggleSearchContext:function(a){var d=b(a.target),e=d.attr("id").replace("dd-","");e==="search-lanes"?b("#search-lanes-filter-friends").show():b("#search-lanes-filter-friends").hide();this.searchContext=e;this.$searchResults.hide();this.$searchTypesA.removeClass("smallButtonActive");d.addClass("smallButtonActive");
this.doSearchDebounce(e);a.preventDefault()},setLaneSearchFilter:function(a){a.attr("id");this.searchLaneScope=a.is(":checked")===true?"friends":"world";this.doContextSearch(0,"search-lanes")},doSearchDebounce:_.debounce(function(a){this.doContextSearch(0,a)},200),doContextSearch:function(a,d,e){var q=this,g=b("#"+d).show(),o=g.find("ul"),n=this.$searchInput.val(),l="",h="",p="",e=e||10,s=b("#"+d+"-hits");q.searchContext=d;switch(d){case "search-memos":l="/search/memos";p="memos";h="";lane=m.currentLane.id;
break;case "search-lanes":l="/search/lanes";p="lanes";h=q.searchLaneScope;lane="";break;case "search-users":l="/search/users",p="users",h="world",lane=""}a==0&&(o.html(""),g.find(".search-results-scrollable").data("jsp")&&g.find(".search-results-scrollable").data("jsp").destroy(),g.show());b("#"+d+"-loader").show();e>a?b.ajax({type:"get",url:l,data:{q:n,start:a,limit:10,scope:h,lane:lane},success:function(e,f,h){b("#"+d+"-loader").hide();a==0&&g.removeClass(q.loaderClass);parseInt(e.hits)==0||h.status==
204?o.find(".search-no-results").length===0&&(b.tmpl(q.templates[d].empty,{}).appendTo(o),s.html(""),g.find(".search-results-scrollable").height(40)):(b.tmpl(q.templates[d].results,e[p]).appendTo(o),o.height()>=q.maxDDContentHeight?g.find(".search-results-scrollable").height(q.maxDDContentHeight).jScrollPane({verticalGutter:q.jScrollGutter}):g.find(".search-results-scrollable").height(o.height()),g.find(".jspScrollable").bind("jsp-scroll-y",function(f,g,h,l){l===true&&(f=a+10,e.hits>f&&q.doContextSearch(f,
d,e.hits),b(this).unbind("jsp-scroll-y"))}),a==0?s.html(e.hits+" total results"):g.find(".search-results-scrollable").data("jsp").reinitialise())}}):b("#"+d+"-loader").hide()},linkToMemo:function(a,b){return m.utilities.breakURLCache(window.location.pathname)+"#time="+b+"&memo="+m.utilities.cleanMemoId(a)},addFriendDialog:function(a){a={username:a.data("username"),first_name:a.data("first_name"),last_name:a.data("last_name")};b.tmpl(m.globalTemplates.dialogs.addFriend,a).lightbox_me({centered:true});
m.dashboard?m.dashboard.addFriend(a.username):b.ajax({type:"post",url:"/friends/"+a.username,success:function(){}})},templates:{"search-memos":{results:'<li class="clearfix"><a href="${m.search.linkToMemo(id, created_at)}" title="view memo"><div class="search-service-icon ${service}-icon"></div><img src="/${user.username}/images" alt="lane" class="search-user-avatar" title="${title}" height="20" width="20" /><div class="search-memos-txt">${title.substring(0, 75) + ( title.length > 75 ? "..." : "") }<span class="search-memos-date">${m.utilities.dateFormat((created_at*1000), "UTC:ddd mmm dd yyyy HH:MM:ss")}</span></div></a></li>',
empty:'<li class="clearfix search-no-results">No memos match that search term!</li>'},"search-lanes":{results:'{{if user}}<li class="clearfix"><a href="/${user.username}/${title}" title="view lane"><img src="/lanes/${id}/avatar.small" class="search-result-icon search-lane-image" alt="topBarAvatar" title="${title}" height="20" width="20" /><span class="search-results-txt">${title}{{if m.currentUser.userID != user_id}}<span class="search-lanes-rel">(${user.first_name} ${user.last_name})</span>{{/if}}</span></a></li>{{/if}}',
empty:'<li class="clearfix search-no-results">No lanes match that search term!</li>'},"search-users":{results:'<li class="clearfix"><a href="/${username}" title="view user profile"><img src="/${username}/images" height="20" width="20" class="search-result-icon search-user-avatar" alt="topBarAvatar"/><span class="search-results-txt">${first_name} ${last_name}<span class="search-users-username">(${username})</span></span> {{if friend=="pending"}}{{else friend=="self"}}{{else friend=="accepted"}}{{else}}<a href="#" data-first_name="${first_name}" data-last_name="${last_name}" data-username="${username}" class="request-friendship" title="request friendship">Request Friendship</a></a>{{/if}}</a></li>',
empty:'<li class="clearfix search-no-results">No users match that search term!</li>'}}}}(this,jQuery,this.undefined);m.search.initialize();
m.dashboard=function(e,b){return{$body:b("body"),$profile:null,$lanes:null,$friends:null,$friendCount:null,$favLanes:b(".dashFaves"),lanesByID:{},favLanesByID:{},allFriendsByUN:{},initialize:function(){this.$profile=this.$body.find("#dashProfile");this.$lanes=this.$body.find(".dashLanes:first");this.$friends=this.$body.find("#dashFriends");this.$friendCount=this.$friends.find("#dashFriendCount");m.dashUser.self?this.$body.find(".dashMineOnly").fadeIn():this.$body.addClass("notMyDashboard");for(x in m.dashUser.lanes)this.lanesByID[m.dashUser.lanes[x].id]=
m.dashUser.lanes[x];for(x in m.dashUser.favorite_lanes)this.favLanesByID[m.dashUser.favorite_lanes[x].id]=m.dashUser.favorite_lanes[x];var a=m.dashUser;for(i in a.friends)this.allFriendsByUN[a.friends[i].username]=a.friends[i];for(j in a.friend_requests)this.allFriendsByUN[a.friend_requests[j].username]=a.friend_requests[j];for(k in a.friends_pending)this.allFriendsByUN[a.friends_pending[k].username]=a.friends_pending[k];this.showMetadata();this.showLanes();this.showFavLanes();this.showFriends();
this.$favLanes.delegate(".remove-fav",m.clickOrTouchEnd,b.proxy(this.removeFavLane,this))},showMetadata:function(){this.$profile.find("img:first").attr("src",m.dashUser.image);this.$profile.find("#dashProfileInfo").find("h2.header span").text(m.dashUser.first_name+" "+m.dashUser.last_name);if(m.currentUser){if(!m.dashUser.self)if(m.dashUser.friend=="accepted")this.$profile.find("#dashIsFriend").html("You are friends!");else if(m.dashUser.friend=="pending")this.$profile.find("#dashIsFriend").html("Friend request pending.");
else if(m.dashUser.friend=="requested"){var a=this,c=this.$profile.find("#dashIsFriend");c.html(m.dashUser.first_name+' requested your friendship: <a href="#" class="confirmFriend">approve</a> or <a href="#" class="rejectFriend">deny</a>.');c.find(".confirmFriend").bind(m.clickOrTouchEnd,function(d){b(this).parent().html("You are now friends!");a.allFriendsByUN[m.currentUser.username]=m.currentUser;a.acceptIncomingFriendDialog(m.dashUser.username);d.preventDefault()});c.find(".rejectFriend").bind(m.clickOrTouchEnd,
function(d){b(this).parent().html("Friendship denied.");a.rejectIncomingFriendDialog(m.dashUser.username);d.preventDefault()})}else a=this,c=this.$profile.find("#dashIsFriend"),c.html('<a href="#" class="btn-orange"><span class="icon">Add as friend</span></a>'),c.bind(m.clickOrTouchEnd,function(b){a.addFriendDialog(m.dashUser.username);b.preventDefault()})}else this.$profile.find("#dashIsFriend").html('<a href="/login">Login</a> or <a href="/signup">signup</a> to add this person as a friend!');if(m.dashUser.self&&
!m.dashUser.bio)m.dashUser.bio='<div style="text-align:center;">You haven\'t added a bio yet.<br /> Go to <a href="/settings/account">My Settings</a> to add one.</div>';this.$profile.find("#dashProfileInfo").find("p").html(m.dashUser.bio);m.dashUser.services.length?this.$profile.find("#dashProfileInfo ul").prepend(b.tmpl(this.templates.service,m.dashUser.services)):m.dashUser.self&&this.$profile.find("#dashProfileInfo li a").text("Add Services")},showLanes:function(){this.$lanes.find(".lanesLoading").hide();
this.$lanes.find("h3 span").text(m.dashUser.lanes.length);var a;a=m.dashUser.self?'<li style="padding:10px 10px 15px;"><strong>You don\'t have any lanes!</strong><br /><br /> Start creating lanes by clicking on the "new lane" button above. Happy Lane making!</li>':'<li style="padding:10px 10px 15px;"><strong>This user has no lanes!</strong></li>';if(m.dashUser.lanes.length){var c=this;a=b.tmpl(this.templates.lane,m.dashUser.lanes);a.find(".removeLane").bind(m.clickOrTouchEnd,function(a){c.removeLaneDialog(b(this).closest("li").attr("id"));
a.preventDefault()});a.find(".dashXContributor").bind(m.clickOrTouchEnd,function(a){c.removeContributorDialog(b(this).closest("li").attr("id"));a.preventDefault()})}this.$lanes.find("ul").html(a)},showFavLanes:function(){this.$favLanes.find(".lanesLoading").hide();this.$favLanes.find("h3 span").text(m.dashUser.favorite_lanes.length);var a;a=m.dashUser.self?'<li style="padding:10px 10px 15px;"><strong>You haven\'t favorited any lanes!</strong><br /><br />Add your lanes to this list by selecting the "heart" button on the lane and never lose track of your favorites.</li>':
'<li style="padding:10px 10px 15px;"><strong>This user has not favorited any lanes!</strong></li>';m.dashUser.favorite_lanes.length&&(a=b.tmpl(this.templates.favLane,m.dashUser.favorite_lanes));this.$favLanes.find("ul").html(a)},showFriends:function(){var a=this.$friends.find(".friendsLoading");a.is(":visible")&&a.hide();this.$friendCount.text(m.dashUser.friends.length);var c=this,d=b.tmpl(this.templates.friends,m.dashUser);d.find(".confirmFriend").bind(m.clickOrTouchEnd,function(a){c.acceptIncomingFriendDialog(b(this).closest("li").attr("id"));
a.preventDefault()});d.find(".rejectIncomingFriend").bind(m.clickOrTouchEnd,function(a){c.rejectIncomingFriendDialog(b(this).closest("li").attr("id"));a.preventDefault()});d.find(".rejectOutgoingFriend").bind(m.clickOrTouchEnd,function(a){c.rejectOutgoingFriendDialog(b(this).closest("li").attr("id"));a.preventDefault()});d.find(".removeFriend").bind(m.clickOrTouchEnd,function(a){c.removeFriendDialog(b(this).closest("li").attr("id"));a.preventDefault()});d.find(".dashAddFriend").bind(m.clickOrTouchEnd,
function(a){c.addFriendDialog(b(this).closest("li").attr("id"));a.preventDefault()});this.$body.find(".dashFriendGroups").slideUp("fast",function(){b(this).html(d).slideDown("fast")})},removeLaneDialog:function(a){var c=this,d=b.tmpl(m.globalTemplates.dialogs.removeLane,this.lanesByID[a]);d.find(".removeConfirm").bind(m.clickOrTouchEnd,function(b){c.removeLane(a);b.preventDefault()});d.lightbox_me({centered:true})},removeContributorDialog:function(a){var c=this,d=b.tmpl(m.globalTemplates.dialogs.removeLaneContributor,
this.lanesByID[a]);d.find(".removeConfirm").bind(m.clickOrTouchEnd,function(b){c.removeLaneContributor(a);b.preventDefault()});d.lightbox_me({centered:true})},acceptIncomingFriendDialog:function(a){if(!this.allFriendsByUN[a]&&m.dashUser.username==a)this.allFriendsByUN[a]=m.dashUser;b.tmpl(m.globalTemplates.dialogs.acceptFriendRequest,this.allFriendsByUN[a]).lightbox_me({centered:true});this.acceptFriend(a)},rejectIncomingFriendDialog:function(a){if(!this.allFriendsByUN[a]&&m.dashUser.username==a)this.allFriendsByUN[a]=
m.dashUser;b.tmpl(m.globalTemplates.dialogs.rejectFriendRequest,this.allFriendsByUN[a]).lightbox_me({centered:true});this.removeFriend(a)},rejectOutgoingFriendDialog:function(a){b.tmpl(m.globalTemplates.dialogs.cancelFriendRequest,this.allFriendsByUN[a]).lightbox_me({centered:true});this.removeFriend(a)},addFriendDialog:function(a){a=this.allFriendsByUN[a]?this.allFriendsByUN[a]:m.dashUser;b.tmpl(m.globalTemplates.dialogs.addFriend,a).lightbox_me({centered:true});this.addFriend(a.username)},removeFriendDialog:function(a){var c=
this,d=b.tmpl(m.globalTemplates.dialogs.removeFriend,this.allFriendsByUN[a]);d.find(".removeConfirm").bind(m.clickOrTouchEnd,function(b){c.removeFriend(a);b.preventDefault()});d.lightbox_me({centered:true})},removeLane:function(a){var c=this;b.ajax({type:"delete",url:"/lanes/"+a,success:function(){delete c.lanesByID[a];m.dashUser.lanes=_.reject(m.dashUser.lanes,function(b){if(b.id==a)return b});if(b(".dashFaves #"+a).length)delete c.favLanesByID[a],m.dashUser.favorite_lanes=_.reject(m.dashUser.favorite_lanes,
function(b){if(b.id==a)return b}),c.showFavLanes();c.showLanes()}})},removeFavLane:function(a){var c=this,d=b(a.target).closest("li").attr("id");b.ajax({url:"/lanes/favorite",type:"DELETE",data:{lane_id:d}}).success(function(){delete c.favLanesByID[d];m.dashUser.favorite_lanes=_.reject(m.dashUser.favorite_lanes,function(a){if(a.id==d)return a});c.showFavLanes()});a.preventDefault()},removeLaneContributor:function(a,c){var d=this;if(!c)c=m.dashUser.username;b.ajax({type:"delete",url:"/lanes/contributor",
data:{lane_id:a,username:c},success:function(){delete d.lanesByID[a];m.dashUser.lanes=_.reject(m.dashUser.lanes,function(b){if(b.id==a)return b});d.showLanes()}})},addFriend:function(a){var c=this;b.ajax({type:"post",url:"/friends/"+a,success:function(){c.allFriendsByUN[a]?c.$friends.find("#"+a+" div").html('<em class="dashAddFriend">Requested</em>'):c.$body.find("#dashIsFriend").html("<em>Friendship requested.</em>")}})},acceptFriend:function(a){var c=this;b.ajax({type:"post",url:"/friends/"+a+"/accept",
success:function(){a!=m.dashUser.username?m.dashUser.friends.unshift(c.allFriendsByUN[a]):m.dashUser.friends.unshift(m.currentUser);m.dashUser.friend_requests=_.reject(m.dashUser.friend_requests,function(b){if(b.username==a)return b});c.showFriends()}})},removeFriend:function(a){var c=this;b.ajax({type:"delete",url:"/friends/"+a,success:function(){delete c.allFriendsByUN[a];m.dashUser.friends=_.reject(m.dashUser.friends,function(b){if(b.username==a)return b});m.dashUser.friend_requests=_.reject(m.dashUser.friend_requests,
function(b){if(b.username==a)return b});m.dashUser.friends_pending=_.reject(m.dashUser.friends_pending,function(b){if(b.username==a)return b});m.dashUser.self&&c.showFriends()}})},templates:{service:'<li class="services-used-${service}" title="${service_name}">${service_name}</li>',lane:'<li id="${id}">\t<a href="/${owner.username}/${title}" class="">\t\t<img src="${avatar_url}">\t\t<span class="dashItemTitle"><em>${title}</em>{{if role=="contributor"}} <em class="dashItemGray">(Contributor)</em>{{/if}}</span>\t\t<span class="dashItemDescription">${description}</span>\t</a>\t{{if m.dashUser.self}}\t\t{{if role == "contributor"}}\t\t\t<a href="#" class="dashXContributor removeContributor" title="Remove myself as a contributor of this lane"></a>\t\t{{else}}\t\t\t<a href="/${owner.username}/${title}#drawer=edit" class="dashE editLane" title="Edit lane">Edit Lane</a>\t\t\t<a href="#" class="dashX removeLane" title="Delete lane">Delete Lane</a>\t\t{{/if}}\t{{/if}}</li>',
favLane:'<li id="${id}">\t<a href="/${owner.username}/${title}" class="">\t\t<img src="${avatar_url}">\t\t<span class="dashItemTitle"><em>${title}</em> <em class="dashItemGray">by</em> {{if m.currentUser && m.dashUser.username === owner.username}} <span class="lane-fav-owner-me">Me</span> {{else}}<span class="lane-fav-owner" data-fav-owner="${owner.username}">${owner.first_name} ${owner.last_name} (${owner.username})</span>{{/if}}</span>\t\t<span class="dashItemDescription">${description}</span>\t</a>\t{{if m.dashUser.self}}\t\t\t<a href="#" class="remove-fav" title="Remove from favorites">remove favorite</a>\t{{/if}}</li>',
friends:'{{if self && !friend_requests.length && !friends_pending.length && !friends.length}}\t<p style="padding:12px 10px 15px; color:#ccc;"><strong>Start adding friends by searching for people you know in the search bar above.</strong></p>{{else}}\t{{if self && friend_requests.length}}\t\t<div>\t\t\t<h4>Friend Requests: Received</h4>\t\t\t<ul class="dashFriends_requested">\t\t\t{{each friend_requests}}\t\t\t\t<li id="${username}">\t\t\t\t\t<a href="/${username}" class="">\t\t\t\t\t\t<img src="${image}">\t\t\t\t\t\t<span class="dashFriendName">${first_name} ${last_name}</span>\t\t\t\t\t\t<span>(${username})</span>\t\t\t\t\t</a>\t\t\t\t\t<div>\t\t\t\t\t\t<a href="#" class="dashY confirmFriend"></a>\t\t\t\t\t\t<a href="#" class="dashX rejectIncomingFriend"></a>\t\t\t\t\t</div>\t\t\t\t</li>\t\t\t{{/each}}\t\t\t</ul>\t\t</div>\t{{/if}}\t{{if self && friends_pending.length}}\t\t<div>\t\t\t<h4>Friend Requests: Sent</h4>\t\t\t<ul class="dashFriends_pending">\t\t\t{{each friends_pending}}\t\t\t\t<li id="${username}">\t\t\t\t\t<a href="/${username}" class="">\t\t\t\t\t\t<img src="${image}">\t\t\t\t\t\t<span class="dashFriendName">${first_name} ${last_name}</span>\t\t\t\t\t\t<span>(${username})</span>\t\t\t\t\t</a>\t\t\t\t\t<div><a href="#" class="dashX rejectOutgoingFriend"></a></div>\t\t\t\t</li>\t\t\t{{/each}}\t\t\t</ul>\t\t</div>\t{{/if}}\t{{if friends.length}}\t\t<ul class="dashFriends_accepted"{{if !friends.length}} style="display:none;"{{/if}}>\t\t{{each friends}}\t\t\t<li id="${username}">\t\t\t\t<a href="/${username}" class="">\t\t\t\t\t<img src="${image}">\t\t\t\t\t<span class="dashFriendName">${first_name} ${last_name}</span>\t\t\t\t\t<span>(${username})</span>\t\t\t\t</a>\t\t\t\t<div>\t\t\t\t\t{{if m.dashUser.self}}\t\t\t\t\t\t<a href="#" class="dashX removeFriend"></a>\t\t\t\t\t{{else}}\t\t\t\t\t\t{{if m.currentUser && !friend && (m.currentUser.username != username)}}\t\t\t\t\t\t\t<a href="#" class="dashAddFriend sml-btn-grey"><span class="icon"></span>Add</a>\t\t\t\t\t\t{{/if}}\t\t\t\t\t{{/if}}\t\t\t\t</div>\t\t\t</li>\t\t{{/each}}\t\t</ul>\t\t{{else}}\t<p style="padding:12px 10px 15px; color:#ccc;"><strong>Everyone needs a friend! Why not befriend this person?</strong></p>\t{{/if}}{{/if}}'}}}(this,
jQuery,this.undefined);m.dashboard.initialize();m.currentUser?$(".user-is-logged-in").show():$(".user-is-not-logged-in").show();$.fn.lightbox_me.defaults.destroyOnClose=true;$.fn.lightbox_me.defaults.centered=true;m.utilities.browser.init();var currentBrowser=m.utilities.browser;(currentBrowser.browser==="Firefox"&&parseInt($.browser.version,10)<6||currentBrowser.browser==="Opera"&&parseInt($.browser.version,10)<11||currentBrowser.browser==="Explorer"&&parseInt($.browser.version,10)<9)&&$('<div class="notifications badnews-notice"><div class="notice-text">Please consider updating your web browser. We built memolane for Explorer 9, Opera 11+, Chrome 12+, Firefox 6+, and Safari 5+. Currently we don\'t support phone devices.<a href="#" class="close-notice">X</a></div></div>').notify({expires:false});
(m.deviceIsIphone||Modernizr.touch&&!m.deviceIsIpad&&!m.deviceIsAndroid||m.deviceIsAndroid&&!navigator.userAgent.toLowerCase().match(/android 3/i))&&$('<div class="notifications badnews-notice"><div class="notice-text">Please consider using an ipad or android (3+) tablet device. Or a modern browser on a desktop or laptop computer. We currently don\'t build memolane for a mobile phone experience. <a href="#" class="close-notice">X</a></div></div>').notify({expires:false});$.ajaxSetup({data:{_csrf:m.csrf}});
$.ajaxPrefilter(function(e){e.type.toLowerCase()==="delete"&&(e.data+="&_method=DELETE")});
